<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1251">
<meta name=Generator content="Microsoft Word 14 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Helvetica;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Courier;
	panose-1:2 7 4 9 2 2 5 2 4 4;}
@font-face
	{font-family:"Tms Rmn";
	panose-1:2 2 6 3 4 5 5 2 3 4;}
@font-face
	{font-family:Helv;
	panose-1:2 11 6 4 2 2 2 3 2 4;}
@font-face
	{font-family:"New York";
	panose-1:2 4 5 3 6 5 6 2 3 4;}
@font-face
	{font-family:System;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"MS Mincho";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
@font-face
	{font-family:Batang;
	panose-1:2 3 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:PMingLiU;
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"MS Gothic";
	panose-1:2 11 6 9 7 2 5 8 2 4;}
@font-face
	{font-family:Dotum;
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:SimHei;
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:MingLiU;
	panose-1:2 2 5 9 0 0 0 0 0 0;}
@font-face
	{font-family:Mincho;
	panose-1:2 2 6 9 4 3 5 8 3 5;}
@font-face
	{font-family:Gulim;
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:Century;
	panose-1:2 4 6 4 5 5 5 2 3 4;}
@font-face
	{font-family:"Angsana New";
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"Cordia New";
	panose-1:2 11 3 4 2 2 2 2 2 4;}
@font-face
	{font-family:Mangal;
	panose-1:2 4 5 3 5 2 3 3 2 2;}
@font-face
	{font-family:Latha;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Sylfaen;
	panose-1:1 10 5 2 5 3 6 3 3 3;}
@font-face
	{font-family:Vrinda;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Raavi;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Shruti;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Sendnya;
	panose-1:0 0 4 0 0 0 0 0 0 0;}
@font-face
	{font-family:Gautami;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Tunga;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Estrangelo Edessa";
	panose-1:3 8 6 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Arial Unicode MS";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Cambria;
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:Tahoma;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"Calibri Light";}
@font-face
	{font-family:"Adobe Caslon Pro Bold";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Adobe Caslon Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Adobe Garamond Pro Bold";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Adobe Garamond Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Caption";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Display";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro SmText";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Subhead";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Light Display";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Smbd";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Smbd Caption";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Smbd Display";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Smbd SmText";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Arno Pro Smbd Subhead";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Bell Gothic Std Black";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Bell Gothic Std Light";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Bickham Script Pro Regular";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Bickham Script Pro Semibold";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Birch Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Blackoak Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Brush Script Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Chaparral Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Charlemagne Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cooper Std Black";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Eccentric Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Garamond Premr Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Garamond Premr Pro Smbd";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Giddyup Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Hobo Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Gothic Pro B";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Gothic Pro B";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Gothic Pro EL";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Gothic Pro EL";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Gothic Pro H";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Gothic Pro H";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Gothic Pro L";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Gothic Pro L";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Gothic Pro M";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Gothic Pro M";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Gothic Pro R";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Gothic Pro R";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Mincho Pro B";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Mincho Pro B";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Mincho Pro EL";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Mincho Pro EL";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Mincho Pro H";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Mincho Pro H";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Mincho Pro L";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Mincho Pro L";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Mincho Pro M";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Mincho Pro M";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Kozuka Mincho Pro R";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Kozuka Mincho Pro R";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Letter Gothic Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Lithos Pro Regular";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Mesquite Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Minion Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Minion Pro Cond";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Minion Pro Med";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Minion Pro SmBd";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Myriad Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Myriad Pro Cond";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Myriad Pro Light";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Nueva Std Cond";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"OCR A Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Orator Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Poplar Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Prestige Elite Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Rosewood Std Regular";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Stencil Std";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Tekton Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Tekton Pro Cond";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Tekton Pro Ext";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Trajan Pro";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"TruthCYR Black";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"TruthCYR Bold";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"TruthCYR Light";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"TruthCYR Medium";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"TruthCYR Regular";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"TruthCYR Thin";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"TruthCYR Ultra";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Mathcad UniMath";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:TeamViewer15;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Marlett;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@Batang";
	panose-1:2 3 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:BatangChe;
	panose-1:2 3 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:"\@BatangChe";
	panose-1:2 3 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:Gungsuh;
	panose-1:2 3 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:"\@Gungsuh";
	panose-1:2 3 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:GungsuhChe;
	panose-1:2 3 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:"\@GungsuhChe";
	panose-1:2 3 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:DaunPenh;
	panose-1:1 1 1 1 1 1 1 1 1 1;}
@font-face
	{font-family:DokChampa;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Euphemia;
	panose-1:2 11 5 3 4 1 2 2 1 4;}
@font-face
	{font-family:Vani;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"\@Gulim";
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:GulimChe;
	panose-1:2 11 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:"\@GulimChe";
	panose-1:2 11 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:"\@Dotum";
	panose-1:2 11 6 0 0 1 1 1 1 1;}
@font-face
	{font-family:DotumChe;
	panose-1:2 11 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:"\@DotumChe";
	panose-1:2 11 6 9 0 1 1 1 1 1;}
@font-face
	{font-family:Impact;
	panose-1:2 11 8 6 3 9 2 5 2 4;}
@font-face
	{font-family:"Iskoola Pota";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Kalinga;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Kartika;
	panose-1:2 2 5 3 3 4 4 6 2 3;}
@font-face
	{font-family:"Khmer UI";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Lao UI";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Lucida Console";
	panose-1:2 11 6 9 4 5 4 2 2 4;}
@font-face
	{font-family:"Malgun Gothic";
	panose-1:2 11 5 3 2 0 0 2 0 4;}
@font-face
	{font-family:"\@Malgun Gothic";
	panose-1:2 11 5 3 2 0 0 2 0 4;}
@font-face
	{font-family:Meiryo;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"\@Meiryo";
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"Meiryo UI";
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"\@Meiryo UI";
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"Microsoft Himalaya";
	panose-1:1 1 1 0 1 1 1 1 1 1;}
@font-face
	{font-family:"Microsoft JhengHei";
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"\@Microsoft JhengHei";
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"Microsoft YaHei";
	panose-1:2 11 5 3 2 2 4 2 2 4;}
@font-face
	{font-family:"\@Microsoft YaHei";
	panose-1:2 11 5 3 2 2 4 2 2 4;}
@font-face
	{font-family:"\@MingLiU";
	panose-1:2 2 5 9 0 0 0 0 0 0;}
@font-face
	{font-family:"\@PMingLiU";
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:MingLiU_HKSCS;
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@MingLiU_HKSCS";
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:MingLiU-ExtB;
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@MingLiU-ExtB";
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:PMingLiU-ExtB;
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@PMingLiU-ExtB";
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:MingLiU_HKSCS-ExtB;
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@MingLiU_HKSCS-ExtB";
	panose-1:2 2 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Mongolian Baiti";
	panose-1:3 0 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"\@MS Gothic";
	panose-1:2 11 6 9 7 2 5 8 2 4;}
@font-face
	{font-family:"MS PGothic";
	panose-1:2 11 6 0 7 2 5 8 2 4;}
@font-face
	{font-family:"\@MS PGothic";
	panose-1:2 11 6 0 7 2 5 8 2 4;}
@font-face
	{font-family:"MS UI Gothic";
	panose-1:2 11 6 0 7 2 5 8 2 4;}
@font-face
	{font-family:"\@MS UI Gothic";
	panose-1:2 11 6 0 7 2 5 8 2 4;}
@font-face
	{font-family:"\@MS Mincho";
	panose-1:2 2 6 9 4 2 5 8 3 4;}
@font-face
	{font-family:"MS PMincho";
	panose-1:2 2 6 0 4 2 5 8 3 4;}
@font-face
	{font-family:"\@MS PMincho";
	panose-1:2 2 6 0 4 2 5 8 3 4;}
@font-face
	{font-family:"MV Boli";
	panose-1:2 0 5 0 3 2 0 9 0 0;}
@font-face
	{font-family:"Microsoft New Tai Lue";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Nyala;
	panose-1:2 0 5 4 7 3 0 2 0 3;}
@font-face
	{font-family:"Microsoft PhagsPa";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Plantagenet Cherokee";
	panose-1:2 2 6 2 7 1 0 0 0 0;}
@font-face
	{font-family:"Segoe Script";
	panose-1:2 11 5 4 2 0 0 0 0 3;}
@font-face
	{font-family:"Segoe UI";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Segoe UI Semibold";
	panose-1:2 11 7 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Segoe UI Light";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Segoe UI Symbol";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"\@SimSun";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:NSimSun;
	panose-1:2 1 6 9 3 1 1 1 1 1;}
@font-face
	{font-family:"\@NSimSun";
	panose-1:2 1 6 9 3 1 1 1 1 1;}
@font-face
	{font-family:SimSun-ExtB;
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:"\@SimSun-ExtB";
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:"Microsoft Tai Le";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Shonar Bangla";
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Microsoft Yi Baiti";
	panose-1:3 0 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Microsoft Sans Serif";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Aparajita;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Ebrima;
	panose-1:2 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Gisha;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:Kokila;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Leelawadee;
	panose-1:2 11 5 2 4 2 4 2 2 3;}
@font-face
	{font-family:"Microsoft Uighur";
	panose-1:2 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:MoolBoran;
	panose-1:2 11 1 0 1 1 1 1 1 1;}
@font-face
	{font-family:Utsaah;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Vijaya;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:Andalus;
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"Arabic Typesetting";
	panose-1:3 2 4 2 4 4 6 3 2 3;}
@font-face
	{font-family:"Simplified Arabic";
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"Simplified Arabic Fixed";
	panose-1:2 7 3 9 2 2 5 2 4 4;}
@font-face
	{font-family:"Sakkal Majalla";
	panose-1:2 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Traditional Arabic";
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:Aharoni;
	panose-1:2 1 8 3 2 1 4 3 2 3;}
@font-face
	{font-family:David;
	panose-1:2 14 5 2 6 4 1 1 1 1;}
@font-face
	{font-family:FrankRuehl;
	panose-1:2 14 5 3 6 1 1 1 1 1;}
@font-face
	{font-family:"Levenim MT";
	panose-1:2 1 5 2 6 1 1 1 1 1;}
@font-face
	{font-family:Miriam;
	panose-1:2 11 5 2 5 1 1 1 1 1;}
@font-face
	{font-family:"Miriam Fixed";
	panose-1:2 11 5 9 5 1 1 1 1 1;}
@font-face
	{font-family:Narkisim;
	panose-1:2 14 5 2 5 1 1 1 1 1;}
@font-face
	{font-family:Rod;
	panose-1:2 3 5 9 5 1 1 1 1 1;}
@font-face
	{font-family:FangSong;
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:"\@FangSong";
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:"\@SimHei";
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:KaiTi;
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:"\@KaiTi";
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:AngsanaUPC;
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"Browallia New";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:BrowalliaUPC;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:CordiaUPC;
	panose-1:2 11 3 4 2 2 2 2 2 4;}
@font-face
	{font-family:DilleniaUPC;
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:EucrosiaUPC;
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:FreesiaUPC;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:IrisUPC;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:JasmineUPC;
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:KodchiangUPC;
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:LilyUPC;
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:DFKai-SB;
	panose-1:3 0 5 9 0 0 0 0 0 0;}
@font-face
	{font-family:"\@DFKai-SB";
	panose-1:3 0 5 9 0 0 0 0 0 0;}
@font-face
	{font-family:"Lucida Sans Unicode";
	panose-1:2 11 6 2 3 5 4 2 2 4;}
@font-face
	{font-family:"Arial Black";
	panose-1:2 11 10 4 2 1 2 2 2 4;}
@font-face
	{font-family:Candara;
	panose-1:2 14 5 2 3 3 3 2 2 4;}
@font-face
	{font-family:"Comic Sans MS";
	panose-1:3 15 7 2 3 3 2 2 2 4;}
@font-face
	{font-family:Consolas;
	panose-1:2 11 6 9 2 2 4 3 2 4;}
@font-face
	{font-family:Constantia;
	panose-1:2 3 6 2 5 3 6 3 3 3;}
@font-face
	{font-family:Corbel;
	panose-1:2 11 5 3 2 2 4 2 2 4;}
@font-face
	{font-family:"Franklin Gothic Medium";
	panose-1:2 11 6 3 2 1 2 2 2 4;}
@font-face
	{font-family:Gabriola;
	panose-1:4 4 6 5 5 16 2 2 13 2;}
@font-face
	{font-family:Georgia;
	panose-1:2 4 5 2 5 4 5 2 3 3;}
@font-face
	{font-family:"Palatino Linotype";
	panose-1:2 4 5 2 5 5 5 3 3 4;}
@font-face
	{font-family:"Segoe Print";
	panose-1:2 0 6 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Trebuchet MS";
	panose-1:2 11 6 3 2 2 2 2 2 4;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:Webdings;
	panose-1:5 3 1 2 1 5 9 6 7 3;}
@font-face
	{font-family:"MT Extra";
	panose-1:5 5 1 2 1 2 5 2 2 2;}
@font-face
	{font-family:"\@Arial Unicode MS";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:"Wingdings 2";
	panose-1:5 2 1 2 1 5 7 7 7 7;}
@font-face
	{font-family:"Wingdings 3";
	panose-1:5 4 1 2 1 8 7 7 7 7;}
@font-face
	{font-family:"Book Antiqua";
	panose-1:2 4 6 2 5 3 5 3 3 4;}
@font-face
	{font-family:"Century Gothic";
	panose-1:2 11 5 2 2 2 2 2 2 4;}
@font-face
	{font-family:"MS Outlook";
	panose-1:5 1 1 0 1 0 0 0 0 0;}
@font-face
	{font-family:"Tempus Sans ITC";
	panose-1:4 2 4 4 3 13 7 2 2 2;}
@font-face
	{font-family:Mistral;
	panose-1:3 9 7 2 3 4 7 2 4 3;}
@font-face
	{font-family:"Lucida Handwriting";
	panose-1:3 1 1 1 1 1 1 1 1 1;}
@font-face
	{font-family:"Kristen ITC";
	panose-1:3 5 5 2 4 2 2 3 2 2;}
@font-face
	{font-family:"Juice ITC";
	panose-1:4 4 4 3 4 10 2 2 2 2;}
@font-face
	{font-family:"Freestyle Script";
	panose-1:3 8 4 2 3 2 5 11 4 4;}
@font-face
	{font-family:"Arial Narrow";
	panose-1:2 11 6 6 2 2 2 3 2 4;}
@font-face
	{font-family:Garamond;
	panose-1:2 2 4 4 3 3 1 1 8 3;}
@font-face
	{font-family:"Monotype Corsiva";
	panose-1:3 1 1 1 1 2 1 1 1 1;}
@font-face
	{font-family:Algerian;
	panose-1:4 2 7 5 4 10 2 6 7 2;}
@font-face
	{font-family:"Baskerville Old Face";
	panose-1:2 2 6 2 8 5 5 2 3 3;}
@font-face
	{font-family:"Bauhaus 93";
	panose-1:4 3 9 5 2 11 2 2 12 2;}
@font-face
	{font-family:"Bell MT";
	panose-1:2 2 5 3 6 3 5 2 3 3;}
@font-face
	{font-family:"Berlin Sans FB";
	panose-1:2 14 6 2 2 5 2 2 3 6;}
@font-face
	{font-family:"Bernard MT Condensed";
	panose-1:2 5 8 6 6 9 5 2 4 4;}
@font-face
	{font-family:"Bodoni MT Poster Compressed";
	panose-1:2 7 7 6 8 6 1 5 2 4;}
@font-face
	{font-family:"Britannic Bold";
	panose-1:2 11 9 3 6 7 3 2 2 4;}
@font-face
	{font-family:Broadway;
	panose-1:4 4 9 5 8 11 2 2 5 2;}
@font-face
	{font-family:"Brush Script MT";
	panose-1:3 6 8 2 4 4 6 7 3 4;}
@font-face
	{font-family:"Californian FB";
	panose-1:2 7 4 3 6 8 11 3 2 4;}
@font-face
	{font-family:Centaur;
	panose-1:2 3 5 4 5 2 5 2 3 4;}
@font-face
	{font-family:Chiller;
	panose-1:4 2 4 4 3 16 7 2 6 2;}
@font-face
	{font-family:"Colonna MT";
	panose-1:4 2 8 5 6 2 2 3 2 3;}
@font-face
	{font-family:"Cooper Black";
	panose-1:2 8 9 4 4 3 11 2 4 4;}
@font-face
	{font-family:"Footlight MT Light";
	panose-1:2 4 6 2 6 3 10 2 3 4;}
@font-face
	{font-family:"Harlow Solid Italic";
	panose-1:4 3 6 4 2 15 2 2 13 2;}
@font-face
	{font-family:Harrington;
	panose-1:4 4 5 5 5 10 2 2 7 2;}
@font-face
	{font-family:"High Tower Text";
	panose-1:2 4 5 2 5 5 6 3 3 3;}
@font-face
	{font-family:Jokerman;
	panose-1:4 9 6 5 6 13 6 2 7 2;}
@font-face
	{font-family:"Kunstler Script";
	panose-1:3 3 4 2 2 6 7 13 13 6;}
@font-face
	{font-family:"Lucida Bright";
	panose-1:2 4 6 2 5 5 5 2 3 4;}
@font-face
	{font-family:"Lucida Calligraphy";
	panose-1:3 1 1 1 1 1 1 1 1 1;}
@font-face
	{font-family:"Lucida Fax";
	panose-1:2 6 6 2 5 5 5 2 2 4;}
@font-face
	{font-family:Magneto;
	panose-1:4 3 8 5 5 8 2 2 13 2;}
@font-face
	{font-family:"Matura MT Script Capitals";
	panose-1:3 2 8 2 6 6 2 7 2 2;}
@font-face
	{font-family:"Modern No\. 20";
	panose-1:2 7 7 4 7 5 5 2 3 3;}
@font-face
	{font-family:"Niagara Engraved";
	panose-1:4 2 5 2 7 7 3 3 2 2;}
@font-face
	{font-family:"Niagara Solid";
	panose-1:4 2 5 2 7 7 2 2 2 2;}
@font-face
	{font-family:"Old English Text MT";
	panose-1:3 4 9 2 4 5 8 3 8 6;}
@font-face
	{font-family:Onyx;
	panose-1:4 5 6 2 8 7 2 2 2 3;}
@font-face
	{font-family:Parchment;
	panose-1:3 4 6 2 4 7 8 4 8 4;}
@font-face
	{font-family:Playbill;
	panose-1:4 5 6 3 10 6 2 2 2 2;}
@font-face
	{font-family:"Poor Richard";
	panose-1:2 8 5 2 5 5 5 2 7 2;}
@font-face
	{font-family:Ravie;
	panose-1:4 4 8 5 5 8 9 2 6 2;}
@font-face
	{font-family:"Informal Roman";
	panose-1:3 6 4 2 3 4 6 11 2 4;}
@font-face
	{font-family:"Showcard Gothic";
	panose-1:4 2 9 4 2 1 2 2 6 4;}
@font-face
	{font-family:"Snap ITC";
	panose-1:4 4 10 7 6 10 2 2 2 2;}
@font-face
	{font-family:Stencil;
	panose-1:4 4 9 5 13 8 2 2 4 4;}
@font-face
	{font-family:"Viner Hand ITC";
	panose-1:3 7 5 2 3 5 2 2 2 3;}
@font-face
	{font-family:Vivaldi;
	panose-1:3 2 6 2 5 5 6 9 8 4;}
@font-face
	{font-family:"Vladimir Script";
	panose-1:3 5 4 2 4 4 7 7 3 5;}
@font-face
	{font-family:"Wide Latin";
	panose-1:2 10 10 7 5 5 5 2 4 4;}
@font-face
	{font-family:"Bookman Old Style";
	panose-1:2 5 6 4 5 5 5 2 2 4;}
@font-face
	{font-family:"Bookshelf Symbol 7";
	panose-1:5 1 1 1 1 1 1 1 1 1;}
@font-face
	{font-family:"MS Reference Sans Serif";
	panose-1:2 11 6 4 3 5 4 4 2 4;}
@font-face
	{font-family:"MS Reference Specialty";
	panose-1:5 0 5 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Berlin Sans FB Demi";
	panose-1:2 14 8 2 2 5 2 2 3 6;}
@font-face
	{font-family:Haettenschweiler;
	panose-1:2 11 7 6 4 9 2 6 2 4;}
@font-face
	{font-family:"OCR-A BT";
	panose-1:2 15 5 1 2 2 4 2 3 4;}
@font-face
	{font-family:"OCR-B 10 BT";
	panose-1:2 11 6 1 2 2 2 2 2 4;}
@font-face
	{font-family:"Swis721 Lt BT";
	panose-1:2 11 4 3 2 2 2 2 2 4;}
@font-face
	{font-family:"Swis721 BT";
	panose-1:2 11 5 4 2 2 2 2 2 4;}
@font-face
	{font-family:"Swis721 Blk BT";
	panose-1:2 11 9 4 3 5 2 2 2 4;}
@font-face
	{font-family:"Swis721 Hv BT";
	panose-1:2 11 8 4 2 2 2 2 2 4;}
@font-face
	{font-family:"Futura Md BT";
	panose-1:2 11 6 2 2 2 4 2 3 3;}
@font-face
	{font-family:"Freehand521 BT";
	panose-1:3 8 8 2 3 3 7 8 3 4;}
@font-face
	{font-family:"Exotc350 DmBd BT";
	panose-1:4 3 7 5 5 11 2 2 10 3;}
@font-face
	{font-family:"Embassy BT";
	panose-1:3 3 6 2 4 5 7 9 12 3;}
@font-face
	{font-family:"EngraversGothic BT";
	panose-1:2 11 5 7 2 2 3 2 2 4;}
@font-face
	{font-family:"Geometr415 Blk BT";
	panose-1:2 11 8 2 2 2 4 2 3 3;}
@font-face
	{font-family:"Geometr212 BkCn BT";
	panose-1:2 11 6 3 2 2 4 2 2 4;}
@font-face
	{font-family:"NewsGoth Cn BT";
	panose-1:2 11 5 6 2 2 2 3 2 4;}
@font-face
	{font-family:"Swis721 LtEx BT";
	panose-1:2 11 5 5 2 2 2 2 2 4;}
@font-face
	{font-family:"News706 BT";
	panose-1:2 4 8 4 6 7 5 2 2 4;}
@font-face
	{font-family:"Clarendon Blk BT";
	panose-1:2 4 9 5 5 5 5 2 2 4;}
@font-face
	{font-family:"Exotc350 Bd BT";
	panose-1:4 3 8 5 5 11 2 2 10 3;}
@font-face
	{font-family:"Geometr706 BlkCn BT";
	panose-1:2 11 7 6 3 5 3 3 2 4;}
@font-face
	{font-family:"Kaufmann BT";
	panose-1:3 8 5 2 3 3 7 8 3 3;}
@font-face
	{font-family:"Humnst777 Lt BT";
	panose-1:2 11 4 2 3 5 4 2 2 4;}
@font-face
	{font-family:"Humnst777 BT";
	panose-1:2 11 6 3 3 5 4 2 2 4;}
@font-face
	{font-family:"Humnst777 Blk BT";
	panose-1:2 11 8 3 3 5 4 3 2 4;}
@font-face
	{font-family:"Century751 BT";
	panose-1:2 4 5 3 5 5 5 2 3 4;}
@font-face
	{font-family:"TypoUpright BT";
	panose-1:3 2 7 2 3 8 7 5 7 5;}
@font-face
	{font-family:"GeoSlab703 MdCn BT";
	panose-1:2 6 5 6 2 2 5 5 4 3;}
@font-face
	{font-family:"DeVinne Txt BT";
	panose-1:2 2 6 4 7 7 5 2 3 3;}
@font-face
	{font-family:"Century725 Cn BT";
	panose-1:2 4 5 6 7 7 5 2 2 4;}
@font-face
	{font-family:"Schadow BT";
	panose-1:2 6 5 4 5 5 5 3 2 4;}
@font-face
	{font-family:"Humnst777 Cn BT";
	panose-1:2 11 5 6 3 5 4 2 2 4;}
@font-face
	{font-family:"Humnst777 BlkCn BT";
	panose-1:2 11 8 3 3 5 4 2 2 4;}
@font-face
	{font-family:"Century751 No2 BT";
	panose-1:2 4 6 4 5 5 5 2 2 4;}
@font-face
	{font-family:"Century751 SeBd BT";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"CentSchbkCyrill BT";
	panose-1:2 4 6 3 5 7 5 2 3 3;}
@font-face
	{font-family:DFGothic-EB;
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:"\@DFGothic-EB";
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:\FF24\FF26\4E2D\592A\6977\66F8\4F53;
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:"\@\FF24\FF26\4E2D\592A\6977\66F8\4F53";
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:DFMincho-UB;
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:"\@DFMincho-UB";
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:DFMincho-SU;
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:"\@DFMincho-SU";
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:\FF24\FF26\660E\671D\4F53W5;
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:"\@\FF24\FF26\660E\671D\4F53W5";
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:DFPOP1-W9;
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:"\@DFPOP1-W9";
	panose-1:2 1 6 9 1 1 1 1 1 1;}
@font-face
	{font-family:"Swis721 WGL4 BT";
	panose-1:2 11 5 4 2 2 2 2 2 4;}
@font-face
	{font-family:"Swis721 Cn BT";
	panose-1:2 11 5 6 2 2 2 3 2 4;}
@font-face
	{font-family:"Bodoni Bk BT";
	panose-1:2 7 6 3 7 7 6 2 3 3;}
@font-face
	{font-family:"Bodoni Bd BT";
	panose-1:2 7 8 3 8 7 6 2 3 3;}
@font-face
	{font-family:"NewsGoth BT";
	panose-1:2 11 5 3 2 2 3 2 2 4;}
@font-face
	{font-family:"NewsGoth Lt BT";
	panose-1:2 11 4 6 2 2 3 2 2 4;}
@font-face
	{font-family:"Futura Bk BT";
	panose-1:2 11 5 2 2 2 4 2 3 3;}
@font-face
	{font-family:"Swis721 BlkCn BT";
	panose-1:2 11 8 6 3 5 2 4 2 4;}
@font-face
	{font-family:"Square721 BT";
	panose-1:2 11 5 4 2 2 2 6 2 4;}
@font-face
	{font-family:"Square721 Cn BT";
	panose-1:2 11 4 6 2 2 2 5 2 4;}
@font-face
	{font-family:"Clarendon Lt BT";
	panose-1:2 4 6 4 4 5 5 2 2 4;}
@font-face
	{font-family:"Clarendon BT";
	panose-1:2 4 7 4 4 5 5 2 2 4;}
@font-face
	{font-family:"Humanst521 Lt BT";
	panose-1:2 11 4 2 2 2 4 2 3 4;}
@font-face
	{font-family:"Humanst521 BT";
	panose-1:2 11 6 2 2 2 4 2 2 4;}
@font-face
	{font-family:"GeoSlab703 Md BT";
	panose-1:2 6 6 3 2 2 5 2 4 3;}
@font-face
	{font-family:"News701 BT";
	panose-1:2 4 6 3 4 5 5 9 2 4;}
@font-face
	{font-family:"FlemishScript BT";
	panose-1:3 3 6 2 5 5 7 15 10 5;}
@font-face
	{font-family:"Alexandra Zeferino One";
	panose-1:3 0 5 0 0 0 0 2 0 3;}
@font-face
	{font-family:"Rosamunda Two";
	panose-1:3 0 6 5 0 0 0 2 0 2;}
@font-face
	{font-family:"Zeferino Two";
	panose-1:3 0 5 0 0 0 0 2 0 3;}
@font-face
	{font-family:"Open Sans";
	panose-1:2 11 6 6 3 5 4 2 2 4;}
@font-face
	{font-family:"PT Serif";
	panose-1:2 10 6 3 4 5 5 2 2 4;}
@font-face
	{font-family:"Liberation Mono";
	panose-1:2 7 4 9 2 2 5 2 4 4;}
@font-face
	{font-family:"Liberation Sans Narrow";
	panose-1:2 11 6 6 2 2 2 3 2 4;}
@font-face
	{font-family:OpenSymbol;
	panose-1:5 1 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"EmojiOne Color";
	panose-1:2 0 5 3 0 0 0 0 0 0;}
@font-face
	{font-family:"DejaVu Math TeX Gyre";
	panose-1:2 0 5 3 0 0 0 0 0 0;}
@font-face
	{font-family:"Linux Biolinum G";
	panose-1:2 0 5 3 0 0 0 0 0 0;}
@font-face
	{font-family:"Source Sans Pro Black";
	panose-1:2 11 8 3 3 4 3 2 2 4;}
@font-face
	{font-family:Caladea;
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Gentium Basic";
	panose-1:2 0 5 3 6 0 0 2 0 4;}
@font-face
	{font-family:Carlito;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"Source Code Pro Black";
	panose-1:2 11 8 9 3 4 3 2 2 4;}
@font-face
	{font-family:"DejaVu Sans";
	panose-1:2 11 6 3 3 8 4 2 2 4;}
@font-face
	{font-family:"DejaVu Sans Light";
	panose-1:2 11 2 3 3 8 4 2 2 4;}
@font-face
	{font-family:"DejaVu Sans Condensed";
	panose-1:2 11 6 6 3 8 4 2 2 4;}
@font-face
	{font-family:"DejaVu Sans Mono";
	panose-1:2 11 6 9 3 8 4 2 2 4;}
@font-face
	{font-family:"DejaVu Serif";
	panose-1:2 6 6 3 5 6 5 2 2 4;}
@font-face
	{font-family:"DejaVu Serif Condensed";
	panose-1:2 6 6 6 5 6 5 2 2 4;}
@font-face
	{font-family:"Gentium Book Basic";
	panose-1:2 0 5 3 6 0 0 2 0 4;}
@font-face
	{font-family:"Liberation Sans";
	panose-1:2 11 6 4 2 2 2 2 2 4;}
@font-face
	{font-family:"Liberation Serif";
	panose-1:2 2 6 3 5 4 5 2 3 4;}
@font-face
	{font-family:"Linux Libertine Display G";
	panose-1:2 0 5 3 0 0 0 0 0 0;}
@font-face
	{font-family:"Linux Libertine G";
	panose-1:2 0 5 3 0 0 0 0 0 0;}
@font-face
	{font-family:"Source Code Pro";
	panose-1:2 11 5 9 3 4 3 2 2 4;}
@font-face
	{font-family:"Source Code Pro ExtraLight";
	panose-1:2 11 3 9 3 4 3 2 2 4;}
@font-face
	{font-family:"Source Code Pro Light";
	panose-1:2 11 4 9 3 4 3 2 2 4;}
@font-face
	{font-family:"Source Code Pro Medium";
	panose-1:2 11 5 9 3 4 3 2 2 4;}
@font-face
	{font-family:"Source Code Pro Semibold";
	panose-1:2 11 6 9 3 4 3 2 2 4;}
@font-face
	{font-family:"Source Sans Pro";
	panose-1:2 11 5 3 3 4 3 2 2 4;}
@font-face
	{font-family:"Source Sans Pro ExtraLight";
	panose-1:2 11 3 3 3 4 3 2 2 4;}
@font-face
	{font-family:"Source Sans Pro Light";
	panose-1:2 11 4 3 3 4 3 2 2 4;}
@font-face
	{font-family:"Source Sans Pro Semibold";
	panose-1:2 11 6 3 3 4 3 2 2 4;}
@font-face
	{font-family:"Roboto Bk";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:Roboto;
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Roboto Cn";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Roboto Lt";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Roboto Th";
	panose-1:0 0 0 0 0 0 0 0 0 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:8.0pt;
	margin-left:0cm;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
h1
	{mso-style-link:"Заголовок 1 Знак";
	margin-top:24.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Calibri Light","sans-serif";
	color:#2E74B5;}
h2
	{mso-style-link:"Заголовок 2 Знак";
	margin-top:10.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:13.0pt;
	font-family:"Calibri Light","sans-serif";
	color:#5B9BD5;}
h3
	{mso-style-link:"Заголовок 3 Знак";
	margin-top:10.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Calibri Light","sans-serif";
	color:#5B9BD5;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:5.0pt;
	margin-left:0cm;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:5.0pt;
	margin-left:11.0pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoToc3, li.MsoToc3, div.MsoToc3
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:5.0pt;
	margin-left:22.0pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
a:link, span.MsoHyperlink
	{color:#0563C1;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:#954F72;
	text-decoration:underline;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"Текст выноски Знак";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:8.0pt;
	font-family:"Tahoma","sans-serif";}
p.MsoTocHeading, li.MsoTocHeading, div.MsoTocHeading
	{margin-top:24.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Calibri Light","sans-serif";
	color:#2E74B5;
	font-weight:bold;}
span.2
	{mso-style-name:"Заголовок 2 Знак";
	mso-style-link:"Заголовок 2";
	font-family:"Calibri Light","sans-serif";
	color:#5B9BD5;
	font-weight:bold;}
span.3
	{mso-style-name:"Заголовок 3 Знак";
	mso-style-link:"Заголовок 3";
	font-family:"Calibri Light","sans-serif";
	color:#5B9BD5;
	font-weight:bold;}
span.1
	{mso-style-name:"Заголовок 1 Знак";
	mso-style-link:"Заголовок 1";
	font-family:"Calibri Light","sans-serif";
	color:#2E74B5;
	font-weight:bold;}
span.a
	{mso-style-name:"Текст выноски Знак";
	mso-style-link:"Текст выноски";
	font-family:"Tahoma","sans-serif";}
span.msoIns
	{mso-style-name:"";
	text-decoration:underline;
	color:teal;}
span.msoDel
	{mso-style-name:"";
	text-decoration:line-through;
	color:red;}
.MsoChpDefault
	{font-family:"Calibri","sans-serif";}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
@page WordSection1
	{size:595.3pt 841.9pt;
	margin:2.0cm 28.3pt 2.0cm 2.0cm;}
div.WordSection1
	{page:WordSection1;}
-->
</style>

</head>

<body lang=RU link="#0563C1" vlink="#954F72">

<div class=WordSection1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal align=center style='margin-bottom:0cm;margin-bottom:.0001pt;
text-align:center'><span style='font-size:22.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Многопоточное программирование в </span><span
lang=EN-US style='font-size:22.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
lang=EN-US style='font-size:22.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:22.0pt;line-height:107%;font-family:"Times New Roman","serif"'><br>
для начинающих</span></p>

<p class=MsoNormal align=center style='margin-bottom:0cm;margin-bottom:.0001pt;
text-align:center'><span style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>(редакция 1.</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>1</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
от </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>13</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>.07.2020г)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal align=right style='margin-bottom:0cm;margin-bottom:.0001pt;
text-align:right'><span style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Автор: Логинов Д.С.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal align=center style='margin-bottom:0cm;margin-bottom:.0001pt;
text-align:center'><span style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Пенза, 2020</span></p>

<p class=MsoTocHeading>Оглавление</p>

<p class=MsoToc1><a
href="#_Toc45535540">1. Вступление<span style='color:windowtext;display:none;
text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></p>

<p class=MsoToc2><a href="#_Toc45535541">1.1 Для чего используется
многопоточное программирование в <span lang=EN-US>Delphi</span><span
style='color:windowtext;display:none;text-decoration:none'> </span><span
style='color:windowtext;display:none;text-decoration:none'>4</span></a></p>

<p class=MsoToc2><a href="#_Toc45535542">1.2 В чём сложность разработки
многопоточных программ в <span lang=EN-US>Delphi</span> по сравнению с другими
современными языками программирования<span style='color:windowtext;display:
none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>4</span></a></p>

<p class=MsoToc2><a href="#_Toc45535543">1.3 Поддержка многопоточности в
операционных системах и процессорах<span style='color:windowtext;display:none;
text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>6</span></a></p>

<p class=MsoToc1><a href="#_Toc45535544">2. Базовый класс многопоточности - <span
lang=EN-US>TThread</span><span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></p>

<p class=MsoToc1><a href="#_Toc45535545">3. Предотвращаем зависание основного
потока (имитация задачи длительного вычисления)<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></p>

<p class=MsoToc1><a href="#_Toc45535546">4. Управление временем жизни потоков<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></p>

<p class=MsoToc2><a href="#_Toc45535547">4.1 Использование свойства <span
lang=EN-US>TThread</span>.<span lang=EN-US>Terminated</span> для выхода из
метода <span lang=EN-US>Execute</span><span style='color:windowtext;display:
none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>14</span></a></p>

<p class=MsoToc2><a href="#_Toc45535548">4.2 Главная форма отвечает за
прекращение работы потока и уничтожение объекта потока<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>15</span></a></p>

<p class=MsoToc2><a href="#_Toc45535549">4.3 Главная форма отвечает за
уничтожение объекта потока с разовой задачей<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>17</span></a></p>

<p class=MsoToc2><a href="#_Toc45535550">4.4 Главная форма отвечает за
уничтожение нескольких долгоживущих потоков<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>19</span></a></p>

<p class=MsoToc2><a href="#_Toc45535551">4.5 Использование списка TObjectList
для хранения ссылок на объекты потоков<span style='color:windowtext;display:
none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>23</span></a></p>

<p class=MsoToc2><a href="#_Toc45535552">4.6 Простой пример организации паузы в
работе потока<span style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>26</span></a></p>

<p class=MsoToc2><a href="#_Toc45535553">4.7 Использование свойства FreeOnTerminate
для автоматического уничтожения объекта потока при завершении работы потока<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>27</span></a></p>

<p class=MsoToc2><a href="#_Toc45535554">4.8 Организация корректного завершения
работы программы при использовании свойства FreeOnTerminate<span
style='color:windowtext;display:none;text-decoration:none'>   </span><span
style='color:windowtext;display:none;text-decoration:none'>28</span></a></p>

<p class=MsoToc1><a href="#_Toc45535555">5. Передача информации из
дополнительного потока в основной<span style='color:windowtext;display:none;
text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>32</span></a></p>

<p class=MsoToc2><a href="#_Toc45535556">5.1 Обращение к визуальным компонентам
формы из дополнительного потока – как нельзя делать<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>32</span></a></p>

<p class=MsoToc2><a href="#_Toc45535557">5.2 Использование метода <span
lang=EN-US>TThread</span>.<span lang=EN-US>Synchronize</span> для передачи
данных в основной поток<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>32</span></a></p>

<p class=MsoToc2><a href="#_Toc45535558">5.3 Периодическое чтение основным
потоком данных, подготовленных в дополнительном потоке<span style='color:windowtext;
display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>36</span></a></p>

<p class=MsoToc2><a href="#_Toc45535559">5.4 Использование функции <span
lang=EN-US>SendMessage</span> для передачи данных в основной поток<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>40</span></a></p>

<p class=MsoToc2><a href="#_Toc45535560">5.5 Использование функции <span
lang=EN-US>PostMessage</span> для передачи очереди сообщений в основной поток<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>44</span></a></p>

<p class=MsoToc2><a href="#_Toc45535561">5.6 Использование списка <span
lang=EN-US>TThreadList</span> для передачи очереди данных в основной поток<span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>46</span></a></p>

<p class=MsoToc2><a href="#_Toc45535562">5.7 Использование метода <span
lang=EN-US>TThread</span>.<span lang=EN-US>Synchronize</span> для передачи
данных в основной поток – вариант с использованием анонимной процедуры<span
style='color:windowtext;display:none;text-decoration:none'>.. </span><span
style='color:windowtext;display:none;text-decoration:none'>50</span></a></p>

<p class=MsoToc2><a href="#_Toc45535563">5.8 Использование метода TThread.Queue
для передачи данных в основной поток<span style='color:windowtext;display:none;
text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>51</span></a></p>

<p class=MsoToc1><a href="#_Toc45535564">6. Где можно и где нельзя создавать и
уничтожать потоки<span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>57</span></a></p>

<p class=MsoToc1><a href="#_Toc45535565">7. Коротко о приоритетах потоков в <span
lang=EN-US>Windows</span><span style='color:windowtext;display:none;text-decoration:
none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>58</span></a></p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h1 style='text-indent:35.45pt'><a name="_Toc45535540">1. Вступление</a></h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В данной работе (условно назовём её
«Учебник») речь пойдет о многопоточном программировании в </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Учебник написан для сообщества </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-программистов
(к этому сообществу следует отнести также </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Lazarus</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-программистов).
В дальнейшем я буду использовать термин «программист», подразумевая именно </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-программиста.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В современных версиях </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>(например,
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Delphi</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'> 10.3) имеется удобная
библиотека многопоточного программирования «</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Parallel</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Programming</span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'> </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Library</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>»
и в последние годы всё больше примеров в интернете даётся именно для </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>PPL</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Она хорошо подходит для тех задач, где требуется распараллелить математические
вычисления либо выполнить параллельную однотипную обработку информации во
множестве файлов на </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>SSD</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-накопителе. На
самом деле, возможности </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>PPL</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
ограничены только фантазией программиста. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Я же постараюсь сделать основной упор на
классическом способе многопоточного программирования в </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>–
работе с классом </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>TThread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(вернее, с классами-наследниками, которые разрабатывают программисты для
решения тех или иных задач). Считаю, что именно классический подход должен
оставаться основным (по крайней мере, программисты должны уметь применять этот
подход на практике и должны ориентироваться в чужом коде, где применяется классический
подход).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>К сожалению, в интернете (в открытых
источниках) очень мало качественного материала, который поможет начинающему
программисту научиться работать с классом </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Формально, материала полно, однако большая его часть, вопреки стараниям
разработчиков этого материала, не учит многопоточному программированию, а чаще
сбивает с толку, в том числе из-за множества ошибочных примеров и советов,
которые нельзя использовать для данной темы.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Профессиональные программисты вероятно
не найдут в данной работе ничего нового. Каких-либо научных открытий здесь не
планируется. В отличие от научных работ, я не планирую увлекаться ссылками на
различные известные источники. Вы всегда можете уточнить любой вопрос с помощью
поисковой машины.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Местами Вы будете встречать несколько
неуклюжую терминологию, объяснения «на пальцах». Сделано так специально, чтобы
не раздувать объём материала и не мучать читателя длинными определениями
общеизвестных терминов.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Я
постараюсь использовать максимально простой стиль изложения материала, надеюсь,
начинающие программисты оценят. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535541">1.1 Для чего
используется многопоточное программирование в </a><span lang=EN-US>Delphi</span></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Я хотел бы выделить две основные причины
использования многопоточности в </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-программах:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1. Длительные математические вычисления
и обработка данных. Примеры: шифрование данных, сжатие данных, анализ данных,
конвертация видео или звука, обучение нейронных сетей и многое другое. Для всех
этих задач характерна высокая и длительная нагрузка на процессор. Очевидно, что
если мы при разработке обычного </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>VCL</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-приложения
попытаемся решить такую задачу без вынесения в отдельный поток, то интерфейс
пользователя подвиснет на время, которое требуется для выполнения вычислений.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. Задачи длительного ожидания
завершения ввода-вывода. Примеры: выполнение </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>HTTP</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-запроса
(или </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>REST</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>-запроса) к какому-либо
сайту в интернете, обмен данными по протоколу </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TCP</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
обмен с устройством по </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>COM</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-порту,
запуск и ожидание работы других программ на компьютере и многое другое. Для
всех этих задач характерна низкая нагрузка на процессор. Ресурсы процессора
практически не задействуются, однако наша программа после запуска операции
будет вынуждена ожидать её завершения. Очевидно, что если мы при разработке
обычного </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>VCL</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>-приложения попытаемся
решить такую задачу без вынесения в отдельный поток, то интерфейс пользователя
подвиснет на время, которое требуется для ожидания завершения операции
ввода-вывода.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535542">1.2 В чём сложность
разработки многопоточных программ в </a><span lang=EN-US>Delphi</span> по
сравнению с другими современными языками программирования</h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В современном программировании принято
разделять разрабатываемую систему на бэкенд и фронтэнд. Бэкенд – это сервис,
который отвечает за хранение данных, их обработку и взаимодействие с
фронтэндом. Фронтэнд – это программа, представляющая интерфейс пользователя.
Она, как правило, не хранит и не обрабатывает данные. Её цель – обеспечить для
пользователя наиболее удобную работу.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
– это прежде всего инструмент для разработки фронтэнда, поскольку мы создаём в
первую очередь программы с графическим интерфейсом пользователя (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>GUI</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).
Программист фронтэнда должен сделать всё возможное, чтобы пользователю было
максимально комфортно работать. Никаких подвисаний интерфейса во фронтэнде быть
не должно! Однако этого достичь в </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>весьма
нелегко. Если мы запрашиваем с сервера данные без использования
многопоточности, то интерфейс программы подвисает на время обработки запроса.
Некоторые сетевые библиотеки позволяют частично обойти данную проблему
(например, режим антизаморозки в </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Overbyte</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>ICS</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'> или </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Indy</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>),
однако далеко не всегда данный режим применим. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Основной режим работы в библиотеке </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Overbyte</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>ICS</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'> – асинхронный, при котором весь
сетевой обмен выполняется в рамках одного потока, этот поток не блокируется
(т.е. не подвисает), однако программист должен самостоятельно реализовать
обработчики различных событий (например, обработчик события получения данных).
Если протокол обмена с сервером состоит из множества запросов и ответов, то
наша программа значительно усложняется, мы можем легко столкнуться с явлением «</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>callback</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>hell</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>» (ад функций обратных вызовов).
Конечно, профессиональный программист такого не допустит и сможет реализовать
машину состояний (конечный автомат), которая избавит от проблемы «</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>callback</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>hell</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>», но профессионалы, к сожалению,
на дороге просто так не валяются. Напомню, статья предназначена в первую
очередь для новичков, которые вряд ли смогут легко справиться с этой задачей. К
тому же, даже если мы и реализуем асинхронный сетевой обмен данными в рамках
одного потока, мы столкнемся с необходимостью обработки принятых данных,
необходимостью выполнять запросы к базе данных, работать с файлами (на
медленном </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>HDD</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>), а в конечном итоге –
к подвисаниям интерфейса пользователя. Знание многопоточного программирования
нам помогает справится с этой проблемой.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>У некоторых других современных языков
программирования (</span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>C</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>#, </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>JavaScript</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Rust</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>, </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Kotlin</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
и т.д., их число постоянно растёт) проблема «</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>callback</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>hell</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>» решена на уровне языка: введён
встроенный механизм асинхронности: </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>async</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
/ </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>await</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>. Смысл в том, что
программист на этих языках пишет простой последовательный код (без обработчиков
событий), а компилятор автоматически преобразует этот код в асинхронный с
использованием машины состояний. Т.е. программист на этих языках теперь не
сталкивается с теми сложностями, с которыми сталкиваемся мы при использовании
асинхронных сетевых библиотек (кстати, это не только </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Overbyte</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>ICS</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>, но и ещё десяток других, в том
числе коммерческих). </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>К слову, программист на языке </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>JavaScript</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
как правило, не сталкивается с многопоточностью. Практически все вещи в </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>JavaScript</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
можно реализовать в контексте одного (главного) потока с использованием
возможностей асинхронности. Конечно, асинхронность не спасёт в ситуациях, когда
требуется выполнить длительные математические расчёты или обработку данных
(интерфейс пользователя будет подвисать на время такой обработки), однако такую
работу выполняет, как правило, бэкэнд.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Мы же используем </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(на мой взгляд – наиболее мощный инструмент для разработки кроссплатформенных </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>GUI</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-приложений
практически для любой платформы) и вынуждены пользоваться теми возможностями,
которые этот инструмент нам предлагает, а встроенной асинхронности у данного
инструмента пока нет.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Давайте же перейдём к теме
многопоточности!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535543">1.3 Поддержка
многопоточности в операционных системах и процессорах</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Буду говорить своими словами, очень
упрощённо. Обязательно почитайте материал на эту тему в Интернете (очень много
классных статей на эту тему есть на ресурсе </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>habr</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>com</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
например, в статьях, посвящённых языку </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>C</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>#).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Я буду говорить в первую очередь о
компьютерах с ОС </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>Windows</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
и процессорах с архитектурой </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Intel</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>x</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>86 (либо </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>AMD</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>x</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>86_64), однако аналогичные
механизмы есть в различных устройствах, оснащённых ОС </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Linux</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Android</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>, </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>MacOS</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>iOS</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'> и процессорами, на которых
работают эти ОС.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Итак, на компьютере одновременно запущены
сотни программ (приложений). Мы называем их также «процессы». Процесс (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>process</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>)
– это объект операционной системы. Когда мы запускаем программу, ОС создаёт
объект «процесс». При создании процесса ОС создаёт также объект «поток» (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>thread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>),
для него создаётся стек вызовов (call stack) и код запускается на исполнение.
Исполняемый код всегда выполняется в контексте какого-то одного потока. В любом
процессе всегда есть минимум один поток. При необходимости, в процессе может
быть более одного потока (например, в процессе </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>WEB</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-сервера
могут быть созданы тысячи потоков). </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В типовом приложении исполняемый код 99%
времени занимается тем, что ожидает поступления каких-либо событий. Как только
событие поступило, исполняемый код «просыпается» и выполняет действия по
обработке этого события, после чего «засыпает» до тех пор, пока не произойдет
следующее событие. Таким образом, на компьютере могут быть созданы одновременно
десятки тысяч потоков, которые 99% времени находятся в спящем состоянии и не
оказывают значительной нагрузки на процессор.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Важно знать, что в ОС присутствует
системный планировщик задач, который отвечает за распределение процессорного
времени между потоками. В том случае, если поток выполняет длительную
вычислительную задачу (обрабатывает информацию), планировщик задач
автоматически выполнит перевод данного потока в спящий режим, как только поток
истратит выделенный ему квант времени (предположим, 50 мс). Кстати, в
большинстве случаев потоки намного раньше переходят в спящий режим, т.к.
выполняют свою задачу раньше, чем успевает закончиться выделенный квант
времени, либо переходят в спящий режим в связи ожиданием завершения
ввода-вывода.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Как только поток переходит в спящий
режим, планировщик задач отыскивает следующий поток, который нуждается в
пробуждении, восстанавливает его контекст и переводит поток в рабочий режим.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Каждый раз, когда поток переходит в
спящий режим, происходит сохранение его контекста (сохраняется текущее
состояние регистров процессорного ядра, на котором поток выполняется). При
переводе потока в рабочий режим выполняется обратное действие – восстановление
контекста потока (загрузка ранее сохраненных значений в регистры процессорного
ядра). <span style='color:#7F7F7F'>Я даю здесь объяснение «на пальцах», а Вы,
если интересно, поищите в интернете более подробную информацию.</span></span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Кстати, операция переключения контекста
по времени далеко не бесплатная, поэтому производители процессоров и
разработчики ОС постоянно делают улучшения для повышения скорости данной
операции. Если Вы хотите создать эффективный высокопроизводительный </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>WEB</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-сервер,
то будет не лишним подумать над тем, как минимизировать количество переключений
контекста при исполнении Вашего кода. <span style='color:#7F7F7F'>Я не буду
давать рекомендаций по поводу создания высокопроизводительного WEB-сервера,
поскольку задача эта больше подходит для специализированных языков
программирования </span></span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif";color:#7F7F7F'>WEB</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif";
color:#7F7F7F'>-серверов, например </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif";color:#7F7F7F'>GoLang</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif";
color:#7F7F7F'>, а </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif";color:#7F7F7F'>Delphi</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif";
color:#7F7F7F'> </span><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif";color:#7F7F7F'>заточен в первую очередь
на разработку фронтэнда, а также корпоративного программного обеспечения.</span></p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri","sans-serif"'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><b><span style='font-size:14.0pt;line-height:107%;
font-family:"Calibri Light","sans-serif";color:#2E74B5'>&nbsp;</span></b></p>

<h1 style='text-indent:35.45pt'><a name="_Toc45535544">2. Базовый класс
многопоточности - </a><span lang=EN-US>TThread</span></h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>TThread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
– это базовый класс, инкапсулирующий функционал для обеспечения работы
параллельного потока. Если мы хотим реализовать код, который должен выполняться
в отдельном потоке, то нам необходимо реализовать наследника от класса </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
и, как минимум, реализовать </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>override</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-метод
</span><b><i><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Код, находящийся внутри метода </span><b><i><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
будет исполняться в отдельном потоке.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>При создании класса-наследника от </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
мы можем реализовать конструктор, деструктор, объявить собственные поля,
методы, свойства и т.д., в зависимости от поставленной перед нами задачи.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В данном разделе я не буду подробно
останавливаться на описании возможностей класса </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Читайте внимательно следующие разделы, надеюсь, в них Вы найдёте необходимую
для Вас информацию.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Дополнительные потоки
  создаются с помощью вызова соответствующей функции операционной системы,
  например </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>CreateThread</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>в ОС </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Windows</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>. Класс </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>TThread</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>является
  обёрткой, которая добавляет к системному дополнительному потоку
  объектно-ориентированное измерение, т.е. позволяет создать объект, который
  привязывается к системному дополнительному потоку.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Существуют и другие
  популярные средства для многопоточного программирования в </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Delphi</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>. К ним стоит
  отнести:</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>- </span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Parallel</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>programming</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>library</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>- стандартная
  библиотека для параллельного программирования в современных версиях </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Delphi</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>.</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>- </span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>OmniThreadLibrary</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> – популярная библиотека
  для параллельного программирования (на июль 2020 библиотека поддерживает
  только </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Windows</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>, однако в
  будущем может появиться поддержка других операционных систем). Ссылка: </span><a
  href="https://github.com/gabr42/OmniThreadLibrary"><span style='font-size:
  14.0pt;font-family:"Times New Roman","serif"'>https://github.com/gabr42/OmniThreadLibrary</span></a></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri","sans-serif"'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><b><span style='font-size:14.0pt;line-height:107%;
font-family:"Calibri Light","sans-serif";color:#2E74B5'>&nbsp;</span></b></p>

<h1 style='text-indent:35.45pt'><a name="_Toc45535545">3. Предотвращаем
зависание основного потока (имитация задачи длительного вычисления)</a></h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже представлен пример кода, в котором имитируется
задача длительного вычисления (функция <b><i>DoLongCalculations</i></b>).
Данная функция запускается двумя путями: 1) из основного потока (см. обработчик
кнопки <b><i>btnRunInMainThread</i></b>); 2) из параллельного потока (см.
обработчик кнопки <b><i>btnRunInParallelThread</i></b>). Данный</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>пример</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Вы</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>можете</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>найти</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>в</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>архиве</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>папка</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
<span lang=EN-US>Ex1).</span></span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Все примеры к данному
  «Учебнику» доступны по ссылке:</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><a
  href="https://github.com/loginov-dmitry/multithread">https://github.com/loginov-dmitry/multithread</a></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>unit
Ex1Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Dialogs, StdCtrls;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
TMyThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
btnRunInParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
btnRunInMainThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure btnRunInMainThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
{ Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
{ Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>{$R
*.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>function
DoLongCalculations: Int64;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
I: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Result</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  // Очень
длинный цикл. Имитирует длительные вычисления.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>for
I := 1 to MaxInt do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
Result := Result + Random(1000);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
MyShowMessage(Msg: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Windows.MessageBox(0, PChar(Msg), '', MB_OK);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TForm1.btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// </span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Запускает</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>параллельный</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
TMyThread.Create(False);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>{
TMyThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TMyThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
V: Int64;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FreeOnTerminate := True;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
V := DoLongCalculations;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
MyShowMessage('</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Результат</span><span lang=EN-US style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>: ' + IntToStr(V));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TForm1.btnRunInMainThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
V: Int64;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
V := DoLongCalculations;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
MyShowMessage('</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Результат</span><span lang=EN-US style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>: ' + IntToStr(V));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Нажмите</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'> </span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>кнопку</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
<b><i><span lang=EN-US>btnRunInMainThread</span></i></b><span lang=EN-US> </span></span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>для</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>запуска</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>функции</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
<b><i><span lang=EN-US>DoLongCalculations</span></i></b><span lang=EN-US> </span></span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>из</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>основного</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>потока</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Через
несколько секунд появится сообщение с результатом вычислений. Длительность
вычислений предсказать сложно, она зависит от характеристик процессора, а также
от его текущего состояния. Приблизительное время – от 5 до 20 секунд. Обратите
внимание, что после запуска вычислений вы не можете выполнять каких-либо
действий с окном (нажимать кнопки, изменять размеры окна и т.д.) до момента
окончания вычислений. Таким образом, запуск функции <b><i>DoLongCalculations</i></b>
из основного приводит к подвисанию интерфейса пользователя.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'> А теперь нажмите кнопку <b><i>btnRunInParallelThread</i></b>
для запуска функции <b><i>DoLongCalculations</i></b> из дополнительного потока.
Вы увидите, что интерфейс пользователя не подвис, а продолжает реагировать на
Ваши действия. Через несколько секунд появится сообщение с результатом
вычислений. Таким образом, запуск функции <b><i>DoLongCalculations</i></b> из
параллельного потока не приводит к подвисанию интерфейса пользователя.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Попробуйте нажать кнопку btnRunInParallelThread
два раза друг за другом. Через несколько секунд (скорее всего дольше, чем до
этого) появится два сообщения с результатами вычислений. Т.е. параллельно друг
другу два дополнительных потока произведут вычисления, а затем выведут
результат на экран.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Сложно предположить, сколько времени
займут вычисления при выполнении двух параллельных потоков. Это зависит от
того, сколько <b>физических</b> ядер у процессора, а также от того, на одном
или на двух разных <b>физических</b> ядрах выполняются потоки. Если наши два
потока будут выполняться на двух разных физических ядрах, то время их
выполнения будет таким же, как время выполнения одного потока, который мы
запускали это этого. Но если они будут выполняться на одном физическом ядре, то
время их выполнения будет примерно в 2 или 3 раза больше (т.е. мы не получим
реального распараллеливания вычислений, хотя интерфейс пользователя и не будет
подвисать).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Я не случайно выделил слово
«физических», поскольку в современных процессорах есть понятие «логическое ядро»
(можете почитать в Интернете про «Hyper-Threading»). Если оба потока будут
работать на двух логических ядрах одного и того же физического ядра, то мы
также не получим реального распараллеливания вычислений.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><b><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Замечание по выдаче окна с сообщением из
дополнительного потока</span></b></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В данном примере для выдачи пользователю
сообщения из дополнительного потока используется функция MyShowMessage. В ней
производится вызов стандартной </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>WinAPI</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-функции
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>MessageBox</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>, которая отображает на
экране окно с заданным текстовым сообщением. Хотя в </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>и
имеется похожая функция для вывода сообщений – </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>ShowMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
однако её нельзя вызывать из дополнительного потока, поскольку она не является
«потокобезопасной», т.е. при обращении к ней из дополнительного потока могут
происходить сбои в работе программы (может и не каждый раз).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Несмотря на то, что в данном примере код
параллельного потока выдаёт пользователю окно с сообщением, я не рекомендую так
делать в реальных программах. Важно помнить, что визуальное информирование
пользователя должно выполняться из основного потока, тогда мы сможем избежать
многих проблем.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><b><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Замечания по использованию свойства TThread.FreeOnTerminate</span></b></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Обратите внимание, что в примере
используется свойство <b><i>FreeOnTerminate</i></b> класса </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
В начале метода <b><i>TMyThread.</i></b></span><b><i><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
мы выставили ему значение </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>True</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Сделано этого для того, чтобы программа автоматически уничтожила объект <b><i>TMyThread</i></b>
(т.е. вызвала деструктор объекта) сразу после завершения работы метода </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Поскольку мы не завели отдельной переменной для хранения ссылки на созданный
объект <b><i>TMyThread</i></b>, то единственный способ уничтожить созданный
объект – попросить его самостоятельно себя уничтожить сразу после завершения
работы метода </span><b><i><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Для этого мы и воспользовались свойством <b><i>FreeOnTerminate</i></b>. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Это лишь один из способов управления
временем жизни объекта потока. Другие способы будет представлены в следующих
разделах.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><b><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Запущенный поток не завершается при
выходе из программы</span></b></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В данном примере есть следующая
проблема: мы можем закрыть программу, не дожидаясь окончания работы
дополнительного потока. Хотя для первого примера это не является проблемой,
однако в реальных программах такая ситуация является недопустимой. Запомните
правило: при выходе из программы Вы должны <b>корректно</b> завершать все
созданные Вами дополнительные потоки. Можно сказать по-другому: нельзя
допустить завершения работы программы, если имеются запущенные Вами
дополнительные потоки. Если Вы не будете следовать этому правилу, то Ваша
программа с большой вероятностью будет глючить. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri","sans-serif"'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><b><span style='font-size:14.0pt;line-height:107%;
font-family:"Calibri Light","sans-serif";color:#2E74B5'>&nbsp;</span></b></p>

<h1 style='text-indent:35.45pt'><a name="_Toc45535546">4. Управление временем
жизни потоков</a></h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>При программировании на языке </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
программист должен самостоятельно думать о том, каким образом будет
уничтожаться тот или иной созданный им объект.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>При программировании дополнительных
потоков мы должны определиться, каким образом будет завершаться работа метода </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
и каким образом будет уничтожаться созданный нами объект потока. При этом мы
должны гарантированно завершить работу потока и уничтожить объект потока при
выходе из программы. Если поток выполняет очень длительную важную задачу и его
нельзя прерывать, то мы должны заблокировать возможность выхода из программы до
момента завершения работы потока.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В зависимости от задачи, которую решает
дополнительный поток, код в методе </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>может
выполняться однократно либо многократно.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Примеры однократного выполнения кода в
методе </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Execute</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>: </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) Выполнение вычислений при нажатии
пользователем кнопки. В этом случае вполне уместно при каждом нажатии
пользователем кнопки создавать дополнительный поток и запускать его.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) Выполнение запроса к базе данных и
обработка данных при срабатывании таймера. Здесь следует пояснить, что таймер
не должен срабатывать слишком часто, иначе расходы на запуск и уничтожение
потока могут оказаться значительными. Также хочу отметить, что при срабатывании
таймера не следует обращаться к базе данных из основного потока, лучше это
делать из дополнительного потока, разумеется, в отдельном подключении.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) Выполнение заданной функции или
процедуры в контексте дополнительного потока с навешиванием модальной формы
ожидания окончания выполнения заданной функции.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4) Можно придумать ещё сотню различных
ситуаций, но такой необходимости у нас нет!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Многократное выполнение кода в методе </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
используется при периодическом выполнении какой-либо задачи, например:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) Раз в секунду выполняется запрос к БД
и при наличии нового задания производится обмен с каким-либо устройством.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) Раз в 15 секунд выполняется
синхронизация данных с сервером.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) 2 раза в секунду выполняется опрос
состояния какого-либо устройства (например, фискального регистратора,
топливно-раздаточной колонки, системы измерения уровня и т.д.).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4) Можно также придумать ещё сотню
различных ситуаций.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:#0070C0'>Внимание!</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> Если
  периодическая задача выполняется редко (например, каждые 10 минут),
  рекомендуется каждый раз (если это не сложно!) для такой задачи создавать
  новый поток. Вероятно, это лучше, чем часами удерживать дополнительный поток
  в спящем состоянии (особенно, если вы разрабатываете 32-разрядное </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Windows</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>-приложение).</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535547">4.1 Использование
свойства </a><span lang=EN-US>TThread</span>.<span lang=EN-US>Terminated</span><span
lang=EN-US> </span>для выхода из метода <span lang=EN-US>Execute</span></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В том случае, если поток запущен на
длительное время (например, пока пользователь не закроет программу) и
периодически выполняет одну и ту же задачу, необходимо предусмотреть механизм
завершения работы метода </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(работа потока завершается именно после выхода из метода </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).
Код внутри метода </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
должен периодически проверять флаг (например, переменную логического типа),
который программа должна установить для того, чтобы поток знал, что пора
завершаться. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Свойство <b><i>TThread.Terminated</i></b>
как раз и является тем флагом, который необходимо периодически проверять для
завершения работы метода </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Ниже представлен пример реализации метода </span><b><i><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
в котором анализируется значения свойства <b><i>Terminated</i></b> (см. папку </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>2).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  procedure WaitTimeout(ATimeOut: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Sleep(ATimeOut);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while not Terminated do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    DoUsefullTask;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    WaitTimeout</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'>(10000); // Ожидаем таймаут 10 сек.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В данном примере реализован бесконечный
цикл </span><b><i><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>while</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
критерием выхода из которого является значение свойства <b><i>Terminated</i></b>,
равное </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>True</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Метод <b><i>DoUsefullTask</i></b>
имитирует выполнение полезной работы, которая длится 5 секунд.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>После каждой итерации выполнения
полезной работы поток должен на какое-то время переходить в спящее состояние.
Напомню, что в спящем состоянии поток не создаёт какой-либо нагрузки на
процессор. Благодаря этому мы даём возможность работать другим потокам (в том
числе в других процессах). </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Для перевода потока в спящее состояние
мы вызываем вложенную (</span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>nested</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>)
процедуру </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>WaitTimeout</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>и
передаём ей длительность ожидания. В свою очередь в ней происходит вызов
стандартной </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>WinAPI</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-функции </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Sleep</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
после чего поток переходит в спящее состояние, длительность которого задана в
миллисекундах (в примере – 10 секунд).</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Если поток переведён в
  спящее состояние с помощью функции </span><span lang=EN-US style='font-size:
  14.0pt;font-family:"Times New Roman","serif"'>Sleep</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>, то не
  существует другого способа выйти из этого состояния кроме истечения
  указанного временного периода. Попробуйте в примере (</span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Ex</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>2) запустить
  параллельный поток (с помощью кнопки <b><i>btnRunParallelThread</i></b>), а
  затем закрыть программу. Вы обнаружите, что выход из программы произойдет не
  сразу, а спустя какое-то время (максимум 15 секунд). На практике вызов
  функции </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Sleep</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>для длительных
  задержек является недопустимым!</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535548">4.2 Главная форма
отвечает за прекращение работы потока и уничтожение объекта потока</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже приведён полный пример из каталога </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>2.
В нём, как уже было сказано, код в методе </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>в
бесконечном цикле выполняет заданную задачу и засыпает на некоторое время.
Работа метода </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Execute</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>завершается
только при выходе из программы:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>unit</span><span lang=EN-US style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'> </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Ex</span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>2</span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Unit</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Windows, Messages, SysUtils, Variants, Classes, Graphics,
Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Dialogs, StdCtrls;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyLongThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure DoUsefullTask; // </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>Процедура</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>для</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>имитации</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>полезной</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>работы</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnRunParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnRunParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread: TMyLongThread;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{$R *.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnRunParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Запускает</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>параллельный</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  if MyThread = nil then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread := TMyLongThread.Create(False)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  else</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>raise</span><span lang=EN-US style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'> </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Exception</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>.</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Create</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>('Дополнительный
поток уже запущен!');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyLongThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread.DoUsefullTask;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Реальный поток может выполнять какую угодно полезную работу</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// В учебных целях делаем паузу 5 секунд для имитации задержки, которая</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// может возникнуть при выполнении полезной работы</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Sleep(5000);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  procedure WaitTimeout(ATimeOut: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Sleep(ATimeOut);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while not Terminated do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    DoUsefullTask;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    WaitTimeout</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'>(10000); // Ожидаем таймаут 10 сек.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// При закрытии программы необходимо завершить работу потока</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>// </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>и</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'> </span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>уничтожить</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>объект</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>потока</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
MyThread</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  if MyThread &lt;&gt; nil then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Обратите внимание на следующие
особенности данного примера:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) не используется свойство </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>FreeOnTerminate</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
т.е. объект потока <b>не</b> уничтожает себя автоматически после завершения
метода </span><b><i><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) при создании объекта потока ссылка на
созданный объект запоминается в переменной <b><i>MyThread</i></b>, которая
является полем класса <b><i>TForm1</i></b>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) блокируется создание нескольких
объектов класса <b><i>TMyLongThread</i></b>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4) завершение работы потока и
уничтожение объекта потока выполняется при выходе из программы путём вызова
стандартного метода <b><i>MyThread.Free</i></b> (в обработчике <b><i>FormDestroy</i></b>).
<span style='color:#7B7B7B'>Хотя технически и нет необходимости проверять
переменную <b><i>MyThread</i></b> на равенство </span></span><b><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif";
color:#7B7B7B'>nil</span></b><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif";color:#7B7B7B'> перед вызовом метода </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif";
color:#7B7B7B'>Free</span></i></b><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif";color:#7B7B7B'>, однако в данном
случае проверка на </span><b><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif";color:#7B7B7B'>nil</span></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif";
color:#7B7B7B'> делает код более наглядным, поскольку программа не обязывает
пользователя нажимать кнопку <b><i>btnRunParallelThread</i></b>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Важно понимать хотя бы приблизительно,
что происходит при вызове <b><i>MyThread.Free</i></b>. А происходит примерно
следующее:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) Производится вызов метода </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></i></b><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Terminate</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
который выставляет свойству <b><i>TThread.Terminated</i></b> значение </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>True</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) Главный поток (т.е. поток,
управляющий интерфейсом пользователя) переводится в спящее состояние до тех
пор, пока в дополнительном потоке не произойдет выход из метода </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) В методе <b><i>Execute</i></b> класса
<b><i>TMyLongThread</i></b> рано или поздно произойдёт проверка значения
свойства <b><i>Terminated</i></b> и бесконечный цикл <b><i>while</i></b>
прервётся, а после этого произойдёт выход из метода <b><i>Execute</i></b> и
работа параллельного потока будет завершена.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4) Главный поток вновь возобновит свою
работу и окончательно уничтожит объект потока <b><i>MyThread</i></b>.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:#0070C0'>Совет! </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Старайтесь и
  Вы сохранять ссылки на создаваемые потоки и уничтожать объекты потоков при
  закрытии (или уничтожении) форм, в которых Вы создавали соответствующий
  поток!</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535549">4.3 Главная форма
отвечает за уничтожение объекта потока с разовой задачей</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Следующий пример (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>3)
интересен тем, что дополнительный поток выполняет разовую задачу длительностью
5 секунд. Обратите внимание, что после завершения работы дополнительного потока
объект потока <b><i>MyThread</i></b> всё ещё жив, и жить он будет до тех пор,
пока не будет произведён выход из программы. Также в примере добавлена
визуализация работы дополнительного потока с помощью модуля <b><i>ProgressViewer.pas</i></b>.
Я его иногда использую в некоторых рабочих проектах, но лицензия не запрещает
его использовать всём желающим. Думаю, что так будет интереснее наблюдать за
работой потоков. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>unit Ex3Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Windows, Messages, SysUtils, Variants, Classes, Graphics,
Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Dialogs, StdCtrls, ProgressViewer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyShortThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure DoUsefullTask; // </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>Процедура</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>для</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>имитации</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>полезной</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>работы</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnRunParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnRunParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread: TMyShortThread;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{$R *.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnRunParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Запускает параллельный поток. Если объект потока уже создан,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>// </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>то</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'> </span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>уничтожает</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>его</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  if MyThread &lt;&gt; nil then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FreeAndNil(MyThread);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  MyThread := TMyShortThread.Create(False);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyShortThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyShortThread.DoUsefullTask;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>AProgress</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>: </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>TProgressViewer</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Реальный поток может выполнять какую угодно полезную работу</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// В учебных целях делаем паузу 5 секунд для имитации задержки, которая</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// может возникнуть при выполнении полезной работы</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>AProgress := TProgressViewer.Create('</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Выполняется</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>поток</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
TMyShortThread');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Sleep(5000);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  AProgress.TerminateProgress;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyShortThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  DoUsefullTask;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// При закрытии программы необходимо завершить работу потока</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>// </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>и</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'> </span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>уничтожить</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>объект</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>потока</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
MyThread</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  if MyThread &lt;&gt; nil then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Хотелось бы отменить ещё некоторые
особенности этого примера:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) При нажатии кнопки <b><i>btnRunParallelThread</i></b>
программа уничтожает объект потока, если он был запущен ранее. Предлагаю
поэкспериментировать с этой кнопкой – понажимать её несколько раз. Вы
обнаружите, что если окно с сообщением «Выполняется поток TMyShortThread»
отображается на экране, то нажатие кнопки  <b><i>btnRunParallelThread</i></b>
приводит к подвисанию интерфейса пользователя до тех пор, пока окно с
сообщением не исчезнет. Затем окно с сообщением появится ещё раз, и отсчёт
времени начнётся с нуля.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) При выходе из программы возможны 3
варианта:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>- Вариант 1: пользователь не нажимал
кнопку <b><i>btnRunParallelThread</i></b>, поэтому объект потока не создан и
ссылка <b><i>MyThread</i></b> равна </span><b><i><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>nil</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
В этом случае программа гарантированно закроется без задержки.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>- Вариант 2: пользователь нажал кнопку <b><i>btnRunParallelThread</i></b>
и сразу, не дожидаясь окончания работы потока (т.е. сообщение «Выполняется
поток TMyShortThread» ещё висело на экране), закрыл программу. В этом случае
произойдет подвисание интерфейса пользователя (максимум 5 секунд), затем, после
завершения работы дополнительного потока, произойдет уничтожение объекта
потока, после чего программа закроется.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>- Вариант 3: пользователь нажал кнопку <b><i>btnRunParallelThread</i></b>,
подождал более 5 секунд (сообщение «Выполняется поток TMyShortThread» исчезло)
и закрыл программу. В этом случае произойдет вызов метода <b><i>MyThread.Free</i></b>,
который просто уничтожит объект потока, который к этому моменту уже завершил
свою работу, а после этого программа закроется.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'> </span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535550">4.4 Главная форма
отвечает за уничтожение нескольких долгоживущих потоков</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Мы уже разобрались, как правильно завершить
работу одного долгоживущего потока при выходе из программы. А как быть, если
таких потоков несколько (например, два или три), а мы хотим максимально
ускорить закрытие программы? В этом случае мы должны заранее сообщить каждому
потоку о необходимости завершения их работы, а уничтожение объектов потоков
выполнить в последнюю очередь. Демонстрация представлена в следующем примере (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>4):</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>unit</span><span lang=EN-US style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'> </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Ex</span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>4</span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Unit</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Windows, Messages, SysUtils, Variants, Classes, Graphics,
Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Dialogs, StdCtrls, ProgressViewer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyLongThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FTaskNum: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure DoUsefullTask1; // Первая задача</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure DoUsefullTask2; // Вторая задача</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>DoFinalizeTask</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>; // Задача
запускается при завершении работы потока</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    constructor Create(TaskNum: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnRunParallelThreads: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Label1: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    cbTerminateMode: TComboBox;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnRunParallelThreadsClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread1: TMyLongThread; // </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>Поток</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>для</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>первой</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>задачи</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'>2: </span><span lang=EN-US style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>TMyLongThread</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>; // Поток
для второй задачи</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{$R *.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnRunParallelThreadsClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Запускает параллельный поток для задачи 1</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>if MyThread1 = nil then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread1 := TMyLongThread.Create(1);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>// Запускает параллельный поток для задачи 2</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>if MyThread2 = nil then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread2 := TMyLongThread.Create(2);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyLongThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>constructor TMyLongThread.Create(TaskNum: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>inherited</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Create</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>(</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>False</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>); //
Вызываем родительский конструктор</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Запоминаем параметр </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>TaskNum</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>. Он нужен
в методе </span><span lang=EN-US style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Execute</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FTaskNum := TaskNum;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread.DoFinalizeTask;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Sleep</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>(5000); // Данная условная задача занимает 5 секунд</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>TMyLongThread</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>.</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>DoUsefullTask</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Sleep</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>(1000); // Данная условная задача занимает 1 секунду</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>TMyLongThread</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>.</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>DoUsefullTask</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>2;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Sleep</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>(2000); // Данная условная задача занимает 2 секунды</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  procedure WaitTimeout(ATimeOut: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Sleep(ATimeOut);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while True do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>if</span><span lang=EN-US style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'> </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Terminated</span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>DoFinalizeTask</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'>; // Некоторые действия при завершении потока</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Exit</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>; // Завершаем работу потока</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end else</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      if FTaskNum = 1 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        DoUsefullTask1  // Запускаем задачу 1</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      else</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        DoUsefullTask2; // Запускаем задачу 2</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      if</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>not</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Terminated</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>then</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> //
Дополнительная проверка не повредит!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>       
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>WaitTimeout</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'>(1000); // Ожидаем таймаут 1 сек</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  AProgress: TProgressViewer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  AProgress := TProgressViewer.Create('Выход из программы');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  try</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    if cbTerminateMode.ItemIndex = 1 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    begin // Выбран режим &quot;Одновременно (быстрее)&quot;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      if Assigned(MyThread1) then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        MyThread1.Terminate; // Выставляем флаг Terminated</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      if Assigned(MyThread2) then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        MyThread2.Terminate; // Выставляем флаг Terminated</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread1.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MyThread2.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  finally</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    AProgress.TerminateProgress;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;  </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В этом примере имеются следующие особенности:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) Поток </span><b><i><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TMyLongThread</span></i></b><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>выполняет
периодически указанное действие: </span><b><i><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>DoUsefullTask</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>1</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
либо </span><b><i><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>DoUsefullTask</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>2</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Номер действия (TaskNum) указан при создании потока, например:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>MyThread1 := TMyLongThread.Create(1);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>MyThread2 := TMyLongThread.Create(2);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) При нажатии кнопки <b><i>btnRunParallelThreads</i></b>
создаются два потока: <b><i>MyThread1</i></b> (для решения задачи 1) и <b><i>MyThread2
</i></b>(для решения задачи 2). Для обоих потоков используется один и тот же
класс <b><i>TMyLongThread</i></b>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) В классе <b><i>TMyLongThread</i></b>
объявлен собственный конструктор </span><b><i><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Create</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Важно! Обратите внимание, что при
  реализации собственного конструктора мы должны обязательно вызвать
  родительский конструктор, например: <b><i>inherited Create(False)</i></b>!</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>При вызове конструктора </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></i></b><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Create</span></i></b><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>требуется
указать логическое значение (параметр <b><i>CreateSuspended</i></b>). Мы
указали значение </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>False</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Это значит, что мы <b>не хотим</b> запускать поток в замороженном (Suspended)
состоянии. Наш поток должен запускаться сразу, как только отработает
конструктор. Если бы мы создавали поток в замороженном состоянии, то для
запуска метода </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Execute</span></i></b><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>нам
пришлось бы вызвать метод </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>TThread</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></i></b><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Resume</span></i></b><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>либо
его современную версию </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>TThread</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></i></b><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Start</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Такая необходимость возникает редко (по крайней мере, в моих проектах).</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Важно! Вы должны знать, что запуск
  метода </span><b><i><span lang=EN-US style='font-size:14.0pt;font-family:
  "Times New Roman","serif"'>Execute</span></i></b><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'> в дополнительном потоке произойдет
  только после того, как работа конструктора полностью завершится!</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4) Логика бесконечного цикла </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>while</span></i></b><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>в
методе </span><b><i><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Execute</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
изменена. Если флаг <b><i>Terminated</i></b> выставлен в </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>True</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
то выполняются некоторые действия (метод <b><i>DoFinalizeTask</i></b>) и
производится выход из метода </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Если же флаг <b><i>Terminated </i></b>имеет значение<b><i> </i></b></span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>False</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
то осуществляется вызов метода <b><i>DoUsefullTask1</i></b> либо <b><i>DoUsefullTask2</i></b>,
в зависимости от переменной <b><i>FTaskNum</i></b>. Далее, перед вызовом
функции <b><i>WaitTimeout</i></b>, производится дополнительная проверка флага <b><i>Terminated</i></b>.
Если он выставлен, то не нужно тратить лишнее время на ожидание, вместо этого
мы должны как можно быстрее завершить работу потока!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>5) В программе пользователь может
выбрать один из способов завершения работы потоков: «последовательно» или
«одновременно». Если выбрать вариант «последовательно» и закрыть программу, то
в методе <b><i>TForm1.FormDestroy</i></b> будет произведён сначала вызов <b><i>MyThread1.Free</i></b>,
а затем вызов <b><i>MyThread2.Free</i></b>. В том случае, если пользователь
предварительно запустил потоки, мы увидим окно с текстом «Выход из программы»,
которое будет отображаться примерно 10 секунд.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Если же мы выберем вариант
«одновременно» и закроем программу, то окно с текстом «Выход из программы»,
будет отображаться примерно 5 секунд. Это происходит благодаря тому, что перед
вызовом <b><i>MyThread1.Free</i></b> осуществляется уведомление потоков о
необходимости завершения их работы путем вызова метода </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></i></b><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Terminate</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(<b><i>MyThread1.Terminate</i></b> и <b><i>MyThread2.Terminate</i></b>). При
вызове <b><i>MyThread1.Free</i></b> ожидается завершение потока <b><i>MyThread1</i></b>,
а затем выполняется уничтожение объекта потока. При вызове <b><i>MyThread2.Free</i></b>
ожидать завершения второго потока долго не придётся, т.к. завершаться он начал
одновременно с первым потоком после вызова <b><i>MyThread2.Terminate</i></b>.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:#0070C0'>Совет! </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Старайтесь при
  выходе из программы заранее вызывать метод </span><b><i><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>TThread</span></i></b><b><i><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>.</span></i></b><b><i><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Terminate</span></i></b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> для каждого
  из запущенных потоков!</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Для данного примера перед
  вызовом метода </span><b><i><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Terminate</span></i></b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> необходимо
  проверять ссылку на объект потока. Если в ней содержится значение </span><b><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>nil</span></b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>, то вызывать
  метод </span><b><i><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Terminate</span></i></b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> нельзя, т.к.
  это приведёт к ошибке доступа к памяти! Также нельзя обращаться к полям,
  свойствам и методам объекта, который не создан! Единственный метод, который
  допускает свой вызов для несозданного объекта: </span><b><i><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>TObject</span></i></b><b><i><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>.</span></i></b><b><i><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Free</span></i></b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>. В нём
  проверяется значение ссылки на объект и если там </span><b><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>nil</span></b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>, то
  деструктор не вызывается.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535551">4.5 Использование списка
TObjectList для хранения ссылок на объекты потоков</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В том случае, если в Вашем приложении
множество потоков, каждый из которых выполняет различные задачи, Вы можете
использовать список TObjectList для хранения ссылок на создаваемые объекты
потоков. В таком случае Вам не придётся писать код уничтожения каждого потока,
достаточно вызвать метод </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Free</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
для списка <b><i>TObjectList</i></b>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В следующем примере (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>5)
демонстрируется работа со списком <b><i>TObjectList</i></b>. Как и в предыдущем
примере, в нём реализовано 2 режима завершения работы потоков при выходе из
программы: последовательный и одновременный.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже представлен исходный код модуля Ex5Unit:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>unit Ex5Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Windows, Messages, SysUtils, Variants, Classes, Graphics,
Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Dialogs, StdCtrls, ProgressViewer, Contnrs, MTUtils;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyLongThread1 = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FUsefullTaskTime: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    constructor Create(UsefullTaskTime: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyLongThread2 = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyLongThread3 = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FUsefullTaskTime: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    constructor Create(UsefullTaskTime: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyLongThread4 = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnRunParallelThreads: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Label1: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    cbTerminateMode: TComboBox;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnRunParallelThreadsClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormCreate(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FList: TObjectList; // </span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Потоки</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>для</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>первой</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>и</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>второй</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>задачи</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{$R *.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnRunParallelThreadsClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Запускаем</span><span lang=EN-US style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'> 4 </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>параллельных</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>потока</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  if FList.Count = 0 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FList.Add(TMyLongThread1.Create(1000));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FList.Add(TMyLongThread2.Create(False));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FList.Add(TMyLongThread3.Create(2000));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FList.Add(TMyLongThread4.Create(False));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyLongThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>constructor TMyLongThread1.Create(UsefullTaskTime: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
inherited Create(False); // Вызываем родительский конструктор</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FUsefullTaskTime := UsefullTaskTime;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread1.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while not Terminated do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    EmulateUsefullWork(FUsefullTaskTime);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadWaitTimeout(Self, 60000); // </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Ожидаем</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>таймаут</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
60 </span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>сек</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Sleep(5000); // Оставлено для демонстрации режима &quot;Одновременно&quot;  </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormCreate(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FList := TObjectList.Create;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  AProgress: TProgressViewer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  I: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  AProgress := TProgressViewer.Create('</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Выход</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>из</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>программы</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  try</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    if cbTerminateMode.ItemIndex = 1 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    begin // </span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'>Выбран</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>режим</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
&quot;</span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Одновременно</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
(</span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>быстрее</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>)&quot;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Выставляем</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>флаг</span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> Terminated
</span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>для</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>всех</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>потоков</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>.
</span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Можно
использовать</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
// родительский класс TThread для операции приведения типов.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>for I := 0 to FList.Count - 1 do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        TThread(FList[I]).Terminate;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>// При уничтожении списка TObjectList будут
уничтожены все объекты потоков</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FList.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  finally</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    AProgress.TerminateProgress;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;  </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyLongThread2 }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread2.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while not Terminated do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    EmulateUsefullWork(2000);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadWaitTimeout(Self, 60000); // </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Ожидаем</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>таймаут</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
60 </span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>сек</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Sleep(5000); // Оставлено для демонстрации режима &quot;Одновременно&quot;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyLongThread3 }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>constructor TMyLongThread3.Create(UsefullTaskTime: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  inherited Create(False);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FUsefullTaskTime := UsefullTaskTime;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread3.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while not Terminated do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    EmulateUsefullWork(FUsefullTaskTime);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadWaitTimeout(Self, 60000); // </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Ожидаем</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>таймаут</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
60 </span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>сек</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Sleep(5000); // Оставлено для демонстрации режима &quot;Одновременно&quot;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyLongThread4 }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyLongThread4.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while not Terminated do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    EmulateUsefullWork(1000);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadWaitTimeout(Self, 60000); // </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Ожидаем</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>таймаут</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
60 </span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>сек</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Sleep(5000); // Оставлено для демонстрации режима &quot;Одновременно&quot;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Обратите внимание на следующие
особенности данного примера:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) Реализованы 4 класса-наследника от </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>:
TMyLongThread1, TMyLongThread2, TMyLongThread3, TMyLongThread4</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Это сделано для того, чтобы показать читателю, что в список </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TObjectList</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
можно добавить произвольные объекты потоков и в любом количестве.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) Список <b><i>FList</i></b> создаётся
в конструкторе формы и уничтожается в деструкторе. Класс </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TObjectList</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
объявлен в модуле «<b><i>Contnrs</i></b>» (вечно забываю, какие буквы в этом
слове и приходится пользоваться поиском по исходникам </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) Для организации паузы в работе
потоков используется простая и удобная функция <b><i>ThreadWaitTimeout</i></b>.
из модуля «MTUtils.pas». Она будет приведена ниже.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4) Для эмуляции полезной работы потоков
используется функция <b><i>EmulateUsefullWork</i></b> из модуля «MTUtils.</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>pas</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>».
Она состоит из одной строчки: <b><i>Sleep(WorkTime)</i></b>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>5) В режиме одновременного завершения
работы потоков в методе <b><i>TForm1.FormDestroy</i></b> в цикле выставляется
значение </span><b><i><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>True</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
свойству <b><i>Terminated</i></b> для каждого объекта-потока из списка </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>FList</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>6) При создании объектов-потоков (в
обработчике <b><i>TForm1.btnRunParallelThreadsClick</i></b>) переменные для
объектов-потоков не объявляются. Результат, возвращаемый при создании объекта
(например, <b><i>TMyLongThread1.Create(1000)</i></b>), можно сразу сохранять в
списке <b><i>FList</i></b>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535552">4.6 Простой пример
организации паузы в работе потока</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже приведён код функции <b><i>ThreadWaitTimeout</i></b>
из модуля «MTUtils.</span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>pas</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>»:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure ThreadWaitTimeout(AThread: TThread; ATimeout:
Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  p: TTimeInterval;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  T: TThreadAccessTerminated;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Получаем доступ к </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>protected</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>-свойству </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Terminated</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>T</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'> := </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>TThreadAccessTerminated</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>(</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>AThread</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Если поток нужно завершить, то сразу выходим из цикла</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>if T.Terminated then Exit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  p</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>.</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Start</span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>; // Начинаем замер времени</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>while True do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    if T.Terminated or (p.ElapsedMilliseconds &gt;= ATimeout)
then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      Exit</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
// Замораживаем поток примерно на 20 мс</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Sleep</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>(ThreadWaitTimeoutSleepTime);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Организация паузы в этой функции
основана на циклическом вызове функции </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Sleep</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>с
небольшим таймаутом (20 мс). При этом контролируется свойство </span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span></i></b><b><i><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></i></b><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Terminated</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Опытные программисты могут использовать более сложные способы организации
паузы, например, с использованием объекта синхронизации «</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Event</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>».
Однако на текущем этапе обучения поднимать тему объектов синхронизации считаю
преждевременным. Для большинства практических задач Вам будет достаточно
функции ThreadWaitTimeout. Задержку в 20 мс считаю оптимальной, она
обеспечивает достаточную точность паузы, но при этом не приводит к слишком
частым переключениям контекста, т.е. практически не оказывает нагрузки на
процессор. При необходимости Вы можете присвоить глобальной переменной ThreadWaitTimeoutSleepTime
другое значение, отличное от 20.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Также обратите внимание, что в этой
функции для организации замеров промежутков времени используется структура (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>record</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>)
TTimeInterval, объявленная в модуле TimeIntervals.pas. Вы можете свободно
использовать модуль TimeIntervals.pas в собственных проектах. Обсуждение
данного модуля ведётся на форуме: </span><a
href="https://www.sql.ru/forum/1326896/modul-dlya-udobnogo-zamera-tochnyh-intervalov-vremeni"><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>https://www.sql.ru/forum/1326896/modul-dlya-udobnogo-zamera-tochnyh-intervalov-vremeni</span></a></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535553">4.7 Использование
свойства FreeOnTerminate для автоматического уничтожения объекта потока при
завершении работы потока</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Давайте снова рассмотрим первый пример (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>1).
В нём был показан вариант реализации потока с использованием свойства <b><i>FreeOnTerminate</i></b>.
Как уже было отмечено ранее, при значении свойства <b><i>FreeOnTerminate=</i></b></span><b><i><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>True</span></i></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
объект потока уничтожается автоматически, как только завершается работа потока.
Вроде удобно, да? Не требуется заводить переменную для объекта-потока, не нужно
писать вызов метода </span><b><i><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Free</span></i></b><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>для
уничтожения объекта потока. Однако тут не всё так просто! Я бы даже сказал, что
у такого подхода больше минусов, чем плюсов. Отмечу такие минусы:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) Сложно контролировать состояние
такого потока, поскольку не объявлена переменная для объекта-потока.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) Сложно управлять таким потоком (по
той же причине).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) Если же мы решим объявить для такого
потока переменную и будем пытаться с нею работать, то рискуем нарваться на
ошибку доступа к памяти «</span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Access</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Violation</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>», поскольку объект
потока может быть уничтожен в любой момент времени.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4) Сложно организовать корректный выход
из программы. Как уже было сказано ранее, при выходе из программы мы должны
гарантировать завершение работы всех запущенных нами потоков. Но это сложно
сделать, если у нас нет ссылки на объект потока.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В первом примере было бы лучше
использовать список </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>TObjectList</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
для хранения ссылок на созданные объекты потоков. Однако такое усложнение могло
бы отпугнуть читателя на этапе знакомства с первым примером.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Вывод такой: я не рекомендую
использовать данный режим уничтожения объектов потоков (особенно для новичков).
Если Вы по каким-то причинам решили его использовать, то следует проявлять
осторожность и предусмотреть механизмы контроля состояния потока и корректного
выхода из программы. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535554">4.8 Организация
корректного завершения работы программы при использовании свойства FreeOnTerminate</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В следующем примере (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>6)
демонстрируется один из подходов к организации корректного выхода из программы
при использовании свойства FreeOnTerminate. Ниже</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'> </span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>представлен</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>код</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>модуля</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
Ex6Unit:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>unit
Ex6Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Dialogs, StdCtrls, ProgressViewer, MTUtils</span><span lang=EN-US> </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>,
TimeIntervals;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
TMyThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
FThreadNum: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
constructor Create;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
destructor Destroy; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
btnRunInParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
{ Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
{ Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
ThreadCount: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
StopThreadsFlag: Boolean;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>{$R
*.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TForm1.btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  //
Запускаем параллельный поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
TMyThread.Create;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
pv: TProgressViewer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// </span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Выставляем</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>флаг</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
StopThreadsFlag, </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>чтобы</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>все</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>потоки</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>завершились</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>StopThreadsFlag
:= True;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  //
Задерживаем выход из программы, пока не будут завершены все потоки</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>if
ThreadCount &gt; 0 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
pv := TProgressViewer.Create('</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'>Ожидаем</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>завершение</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>потоков</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
while ThreadCount &gt; 0 do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
Sleep(10);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
pv.TerminateProgress;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>{
TMyThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>constructor
TMyThread.Create;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  inherited
Create(False);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  //
Увеличиваем глобальную переменную ThreadCount на 1 и запоминаем</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  // полученное
значение</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>FThreadNum
:= InterlockedIncrement(ThreadCount);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>destructor
TMyThread.Destroy;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>inherited</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  //
Уменьшаем глобальную переменную ThreadCount на 1</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>InterlockedDecrement(ThreadCount);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TMyThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
ti: TTimeInterval;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FreeOnTerminate := True;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>//
Организуем паузу 10 секунд. При этом каждые 20 мс </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  // проверяем
флаг </span><span lang=EN-US style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>StopThreadsFlag</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>ti</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>.</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Start</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>while</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>ti</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>.</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>ElapsedSeconds</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> &lt; 10 </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>    //
Заканчиваем ожидание, если выставлен флаг </span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>StopThreadsFlag</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>    </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>if
StopThreadsFlag then Break;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
Sleep(20);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
ThreadShowMessageFmt('Работа потока #%d завершена!', [FThreadNum]); </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Особенности
данного примера:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>1.
Введены две глобальные переменные: ThreadCount (количество запущенных потоков)
и StopThreadsFlag (флаг завершения потоков).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. Для увеличения переменной ThreadCount
на единицу используется потокобезопасная функция InterlockedIncrement. В принципе,
в этом примере мы могли бы использовать операцию инкремента </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Inc</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(либо ThreadCount := ThreadCount + 1), однако, операция </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Inc</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
не является потокобезопасной и при одновременном вызове </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Inc</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>(ThreadCount)
из нескольких потоков мы могли бы получить некорректное значение (например, 9
вместо 10). </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3. Каждому запущенному потоку
присваивается порядковый номер </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>FThreadNum</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Для этого используется результат, который возвращает функция InterlockedIncrement.
Благодаря функции InterlockedIncrement гарантируется, что каждый поток получит
свой уникальный порядковый номер. Если бы мы использовали следующий код для
увеличения ThreadCount и запоминания </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>FThreadNum</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>ThreadCount :=
ThreadCount + 1; // </span><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>либо</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'> <span lang=EN-US>Inc(ThreadCount)</span></span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>FThreadNum</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
:= ThreadCount;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>то столкнулись бы со следующими
проблемами (с вероятностью примерно 1%):</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>а) при одновременном вызове ThreadCount :=
ThreadCount + 1 из нескольких потоков мы можем получить некорректное значение
(например, 9 вместо 10). Тут есть очень простое объяснение. Допустим, 2 потока
начали выполнять команду инкремента одновременно, в этом момент в переменной ThreadCount
хранилось значение 8. Далее оба потока одновременно увеличили это значение на
1, получилось значение 9. Функция InterlockedIncrement такого не допустит!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>б) даже если инкремент </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>ThreadCount</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
был выполнен корректно, существует риск того, что в поле </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>FThreadNum</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
нескольких потоков попадёт одно и то же значение. Причина этого может
заключаться в том, что планировщик задач </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Windows</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
может в любой момент приостановить работу потока, например, непосредственно
перед инструкцией </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>FThreadNum</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
:= ThreadCount. После того, как планировщик возобновит работу потока, в
переменной ThreadCount может оказаться совсем другое значение. Функция InterlockedIncrement
такого не допустит!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4. Для уменьшения переменной ThreadCount
на единицу используется потокобезопасная функция InterlockedDecrement в методе-деструкторе
TMyThread.Destroy.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>5. Для остановки потоков используется
глобальная переменная StopThreadsFlag. Ей присваивается значение </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>True</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
в методе TForm1.FormDestroy. Переменная StopThreadsFlag проверяется в цикле в
методе TMyThread.Execute. Цикл прерывается после того, как в переменной StopThreadsFlag
окажется значение </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>True</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>. Перед выходом
из метода TMyThread.Execute выдаётся сообщение с текстом «Работа потока #%d
завершена!». Для вывода сообщения используется функция ThreadShowMessageFmt,
объявленная в модуле MTUtils. Также обратите внимание, что деструктор будет
вызван после выхода из метода TMyThread.Execute!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>6. Для организации цикла ожидания 10
секунд в методе TMyThread.Execute используется тип TTimeInterval, объявленный в
модуле TimeIntervals. Обратите внимание, что поддержка методов в записях
появилась в версии </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
2007, поэтому в более ранних версиях </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
примеры не скомпилируются.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>7. При выходе из приложения в методе TForm1.FormDestroy
выставляется флаг «StopThreadsFlag := True», а затем выполняется цикл ожидания
нулевого значения в переменной ThreadCount. Данная переменная проверяется
каждые 10 мс (пауза в работе основного потока организована с помощью </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Sleep</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>(10)).
Выход из программы произойдет после того, как пользователь нажмёт кнопку «ОК»,
во всех сообщениях, открытых из дополнительных потоков.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>8. Кнопка btnRunInParallelThread может
быть нажата произвольное количество раз.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<span style='font-size:11.0pt;line-height:107%;font-family:"Calibri","sans-serif"'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal><b><span style='font-size:14.0pt;line-height:107%;
font-family:"Calibri Light","sans-serif";color:#2E74B5'>&nbsp;</span></b></p>

<h1 style='text-indent:42.55pt'><a name="_Toc45535555">5. Передача информации
из дополнительного потока в основной</a></h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>При разработке многопоточных приложений
в </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Delphi</span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'> </span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>очень
актуальной является задача передачи информации, подготовленной в дополнительном
потоке, в главный поток. Это весьма сложная тема, требующая от </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-программиста
повышенного внимания, т.к. при недостаточных знаниях у программиста есть очень
высокий шанс сделать программу глюченной и нестабильной.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535556">5.1 Обращение к
визуальным компонентам формы из дополнительного потока – как нельзя делать</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Не допускается обращение к
  визуальным компонентам из дополнительного потока! Т.е. внутри метода </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Execute</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>мы не можем
  просто так взять, и изменить что-либо на форме. Например, следующие
  инструкции внутри метода </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Execute</span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>недопустимы</span></b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>:</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Courier New"'>Form</span><span
  style='font-size:12.0pt;font-family:"Courier New"'>1.</span><span lang=EN-US
  style='font-size:12.0pt;font-family:"Courier New"'>Label</span><span
  style='font-size:12.0pt;font-family:"Courier New"'>1 := 'Привет';</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Courier New"'>Form1.Show;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Courier New"'>Form1.ShowModal;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Courier New"'>Form1.Button1.Visible :=
  True;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:12.0pt;font-family:"Courier New"'>Form1.Memo1.Lines.Add('</span><span
  style='font-size:12.0pt;font-family:"Courier New"'>Привет</span><span
  lang=EN-US style='font-size:12.0pt;font-family:"Courier New"'>');</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>и т.д.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Запомните, что интерфейс пользователя
обслуживается основным (главным) потоком! Любые изменения, влияющие на
интерфейс пользователя должны всегда выполняться в контексте основного потока!
Это не является уникальной особенностью </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Для других языков программирования, в которых имеется поддержка разработки
визуальных интерфейсов, действует такое же правило!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535557">5.2 Использование метода
</a><span lang=EN-US>TThread</span>.<span lang=EN-US>Synchronize</span><span
lang=EN-US> </span>для передачи данных в основной поток</h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>есть
механизм, позволяющий дополнительному потоку выполнить запуск процедуры
(метода) в контексте основного потока. Для этого предназначен метод TThread.Synchronize.
Суть работы данного метода состоит в следующем:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1. Метод Synchronize запоминает в списке
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>SyncList</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'> (глобальная переменная
типа </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>TList</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>) переданный ему метод
(метод представляет собой структуру-запись </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TMethod</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
в которой есть всего 2 поля: адрес функции и указатель на объект). Например,
если мы выполним такой код: TThread.Synchronize (</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>nil</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Form</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>1.</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Show</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>),
то в списке будет сохранён указатель на объект (т.е. </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Form</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>1)
и адрес процедуры </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>TForm</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Show</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. Основной поток периодически проверяет
наличие элементов в списке </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>SyncList</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Если в списке обнаружен элемент, то производится запуск метода, хранящегося в
списке.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3. Метод TThread.Synchronize, вызванный
в дополнительном потоке, вернёт управление после того, как основной поток
завершит вызов переданного ему метода.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Обратите внимание, что в
  метод TThread.Synchronize можно передавать только методы-процедуры без
  параметров! Если нужны параметры, то Вы должны завести в своём классе потока
  дополнительные поля, присвоить им значения до вызова Syncronize, а затем
  использовать эти значения при вызове метода, который вы передали в Syncronize,
  в контексте основного потока.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:#0070C0'>Совет! </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>В современных
  версиях </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Delphi</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>в метод Syncronize
  можно передавать анонимную процедуру. В этом случае намного реже возникает
  необходимость в объявлении дополнительных полей в классе потока.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Каждый вызов TThread.Synchronize
  несёт в себе значительные накладные расходы, поэтому старайтесь использовать
  его как можно реже. В идеале, старайтесь обойтись без него.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Нельзя уничтожать
  дополнительные потоки из метода, который Вы передаёте в TThread.Synchronize!
  Это приводит к зависанию программы.</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже представлен пример (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>7),
в котором дополнительный поток выполняет длительные вычисления (суммирует ряд
чисел от 1 до </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>MaxValue</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>) и периодически
вызывает метод Synchronize для отображения прогресса на главной форме.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>unit Ex7Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Windows, Messages, SysUtils, Variants, Classes, Graphics,
Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Dialogs, StdCtrls, MTUtils, ComCtrls;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FResult: Int64;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FCurrValue: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure SetProgressParams;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure SetProgressCurrValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    MaxValue: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnRunInParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ProgressBar1: TProgressBar;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Label1: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    labResult: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    edMaxValue: TEdit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FMyThread: TMyThread;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{$R *.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Уничтожаем</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>запущенный</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  if Assigned(FMyThread) then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FreeAndNil(FMyThread);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>// Создаём поток в спящем состоянии</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FMyThread := TMyThread.Create(True);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Запоминаем длину ряда в поле MaxValue</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FMyThread.MaxValue := StrToIntDef(edMaxValue.Text, 0);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>// Пробуждаем поток для выполнения вычислений</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FMyThread.Resume;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FMyThread.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Res: Int64;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  CurrVal: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Выставляем</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>параметры</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>компонента</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
ProgressBar1</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Synchronize(SetProgressParams);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Выполняем</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>некоторые</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>вычисления</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Res := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  CurrVal := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while CurrVal &lt; MaxValue do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    if Terminated then Break;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Inc(CurrVal);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Res := Res + CurrVal;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    if CurrVal mod 10000 = 0 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>begin // Обновление прогресса выполняется только 1
раз из 10000</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FCurrValue := CurrVal;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      FResult    := Res;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      Synchronize(SetProgressCurrValue);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Обновляем прогресс в конце вычислений</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FCurrValue := CurrVal;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FResult    := Res;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Synchronize(SetProgressCurrValue);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.SetProgressCurrValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1.ProgressBar1.Position := FCurrValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1.labResult.Caption := IntToStr(FResult);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.SetProgressParams;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1.ProgressBar1.Max := MaxValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1.ProgressBar1.Position := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1.labResult.Caption := '0';</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Особенности данного примера:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1. Объект дополнительного потока
создаётся с параметром </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>True</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(FMyThread := TMyThread.Create(True)). Это означает, что метод </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
не будет вызван до тех пор, пока программа не вызовет метод Resume (либо </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Start</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>в
современных версиях </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).
Таким образом, Вы можете создавать поток в замороженном состоянии, а запускать
его позже, когда Вам будет удобно.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. Запуск дополнительного потока
осуществляется вызовом FMyThread.Resume.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:red'>Внимание!</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> В объявлении
  класса </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>TThread</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>рядом с
  методом Resume находится метод </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Suspend</span><span style='font-size:
  14.0pt;font-family:"Times New Roman","serif"'>, предназначенный для
  принудительного перевода потока в спящее состояние. Вы не должны его
  использовать! Многие начинающие программисты пытаются управлять состоянием
  потока с помощью метода </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Suspend</span><span style='font-size:
  14.0pt;font-family:"Times New Roman","serif"'>, однако, как правило, ни к
  чему хорошему это не приводит, кроме глюков в программе.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3. Установка параметров компонента ProgressBar1,
а также визуализация прогресса осуществляется вызовом метода Synchronize:
Synchronize(SetProgressParams) и Synchronize(SetProgressCurrValue).</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:red'>Внимание!</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> Не забывайте
  вызывать метод Synchronize! Нет ничего проще, чем забыть это сделать
  (например, вызвать SetProgressCurrValue вместо Synchronize(SetProgressCurrValue))!
  </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Delphi</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Вам не
  подскажет, зато при работе программы будут возникать сбои.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4. Перед вызовом </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Synchronize</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>(</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>SetProgressCurrValue</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>)
выполняется установка значений полям </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>FCurrValue</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>и
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>FResult</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>, поскольку они в дальнейшем
используются в методе </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>SetProgressCurrValue</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>5. Вызов Synchronize(SetProgressCurrValue)
выполняется каждую десятетысячную итерацию цикла (см. условие «if CurrVal mod
10000 = 0 then…»). Если вызывать Synchronize чаще, то скорость вычислений
замедлится, а нагрузка на главный поток программы возрастёт.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Обратите внимание, что для выхода из
  программы не обязательно дожидаться окончания работы потока. Вызов FMyThread.Free
  в методе TForm1.FormDestroy не приводит к зависанию программы, несмотря на
  то, что в методе TMyThread.Execute последней строкой осуществляется вызов
  метода Synchronize. Взаимной блокировки главного и дополнительного потока не
  происходит, т.к. в деструкторе объекта потока вызывается код, который
  предотвращает взаимную блокировку.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535558">5.3 Периодическое чтение
основным потоком данных, подготовленных в дополнительном потоке</a></h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В следующем примере (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>8)
задача визуализации текущего состояния вычислений, выполняющихся в
дополнительном потоке, решается без использования метода Synchronize. На
главной форме находится таймер, который через определённые промежутки времени
(каждые 100 мс) считывает из объекта-потока FMyThread свойства CalcResult, CurrValue
и ThreadStateInfo и отображает их значения на главной форме.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>На мой взгляд, такой код становится
проще и логичнее, чем при использовании метода Synchronize. Дополнительный
поток занимается своим делом (выполняет вычисления) и не мешает главному потоку.
Главный поток занимается своим делом – обслуживает интерфейс пользователя. Даже
если главный поток подвиснет, что часто происходит при работе с базами данных,
это никак не повлияет на работу дополнительного потока.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Вы не всегда сможете обойтись без Synchronize,
но если задача позволяет и качество кода не ухудшится, то старайтесь сделать
это. Но имейте ввиду, что сложные структуры, такие как строки, динамические
массивы, объекты, варианты, и т.п. придётся (вероятно) защитить от
одновременного доступа из разных потоков. Одной из целей данного примера
является показать, как защитить строку (</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>string</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже исходный код примера </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>8:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>unit
Ex8Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Dialogs, StdCtrls, MTUtils, ComCtrls, ExtCtrls, SyncObjs;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
TMyThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
FMaxValue: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
FResult</span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>:
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Int</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>64;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>    </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>FCurrValue</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>: </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Integer</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>    //
Информация о текущем состоянии потока</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>    </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>FThreadStateInfo:
string;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
function GetThreadStateInfo: string;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure SetThreadStateInfo(const Value: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
constructor Create(MaxValue: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
property CalcResult: Int64 read FResult;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
property CurrValue: Integer read FCurrValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>//
Свойство для доступа к строке </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>FThreadStateInfo</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> с помощью</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>    </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>//
потокозащищенных методов GetThreadStateInfo и SetThreadStateInfo</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
property ThreadStateInfo: string read GetThreadStateInfo </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>                                    
write SetThreadStateInfo;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
btnRunInParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
ProgressBar1: TProgressBar;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
Label1: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
labResult: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
edMaxValue: TEdit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
Timer1: TTimer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
Label2: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
labThreadStateInfo: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
procedure Timer1Timer(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
{ Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
FMyThread: TMyThread;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
{ Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>{$R
*.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TForm1.btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
MaxValue: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Уничтожаем запущенный поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
if Assigned(FMyThread) then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
FreeAndNil(FMyThread);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
MaxValue := StrToInt(edMaxValue.Text);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
ProgressBar1.Max := MaxValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
ProgressBar1.Position := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
labResult.Caption := '0';</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
labThreadStateInfo.Caption := '???';</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FMyThread := TMyThread.Create(MaxValue);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FreeAndNil(FMyThread);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TForm1.Timer1Timer(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
if Assigned(FMyThread) then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
ProgressBar1.Position := FMyThread.CurrValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
labResult.Caption     := IntToStr(FMyThread.CalcResult);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
labThreadStateInfo.Caption := FMyThread.ThreadStateInfo;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>{
TMyThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>constructor
TMyThread.Create(MaxValue: Integer);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FMaxValue := MaxValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
inherited Create(False);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TMyThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
ThreadStateInfo := 'Start';</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
while FCurrValue &lt; FMaxValue do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
if Terminated then Break;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
Inc(FCurrValue);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
FResult := FResult + FCurrValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
ThreadStateInfo := Format('Progress: %f%%',</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
[FCurrValue / FMaxValue * 100]);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
ThreadStateInfo := 'Complete';</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>function
TMyThread.GetThreadStateInfo: string;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  //
Защищаем строку с помощью критической секции. Если её убрать,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  // то в
главном потоке периодически будет возникать ошибка</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>//
&quot;Invalid pointer operation&quot; либо &quot;Out of memory&quot;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
StringProtectSection</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>.</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Enter</span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>; // Входим в режим защиты</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>  </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Result
:= FThreadStateInfo;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
StringProtectSection.Leave; // Выходим из режима защиты</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>procedure
TMyThread.SetThreadStateInfo(const Value: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
StringProtectSection.Enter; // Входим в режим защиты</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FThreadStateInfo := Value;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
StringProtectSection</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>.</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Leave</span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>; // Выходим из режима защиты</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt'><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-indent:
35.45pt'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Особенности
данного примера:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1. Введено дополнительное строковое поле
FThreadStateInfo (информация о текущем состоянии потока). Доступ к этому полю
осуществляется с помощью потокозащищённого свойства ThreadStateInfo,
использующего методы GetThreadStateInfo и SetThreadStateInfo для чтения и
записи строки FThreadStateInfo. Перед тем, как записать либо прочитать строку,
выполняется вход в режим защиты с помощью кода StringProtectSection.Enter.
После того, как работа со строкой завершилась, выполняется выход из режима
защиты с помощью кода StringProtectSection.Leave.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:red'>Внимание!</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> После каждого
  входа в режим защиты обязательно должен осуществляться выход из режима
  защиты.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:#0070C0'>Совет.</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif";color:red'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Защищать
  строки (и другие структуры и объекты) имеет смысл при наличии двух условий:</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>а) предполагается, что будет
  одновременный доступ к строке (структуре, объекту, массиву) из разных
  потоков;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>б) строка (структура, объект, массив)
  не является «константной», т.е. она может меняться в зависимости от логики
  программы (в таких случаях используют ещё термин «</span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>mutable</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>» или
  «мутабельный»).</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:red'>Внимание! </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Если строка
  (структура, объект, массив) является «константной», т.е. если значение
  присваивается лишь один раз и больше не меняется, то нет смысла её защищать!</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. Глобальная переменная </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>StringProtectSection</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(класс </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>TCriticalSection</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>)
объявлена в модуле </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>MTUtils</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
а соответствующий ей объект создаётся в секции </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>initialization</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3. Непосредственный доступ к полям класса
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>TMyThread</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'> (</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>FResult</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>FCurrValue</span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'> </span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>и
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>FThreadStateInfo</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>) допускается только из
методов класса </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>TMyThread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Сторонний код должен использовать соответствующие свойства: CalcResult, CurrValue,
ThreadStateInfo. Свойства CalcResult и CurrValue обеспечивают доступ к полям</span>
<span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>FResult
и FCurrValue только для чтения.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#BDD6EE;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Что будет, если закомментировать
  строки StringProtectSection.Enter и StringProtectSection.Leave? У меня в этом
  случае в программе иногда возникают следующие ошибки: &quot;Invalid pointer
  operation&quot; либо &quot;Out of memory&quot;. Особенно легко ошибки
  воспроизвести, если запустить одновременно 4 экземпляра программы. Я не могу
  объяснить, из-за чего выдаётся &quot;Out of memory&quot;, а с ошибкой &quot;Invalid
  pointer operation&quot; объяснение может быть таким: при каждом присвоении
  новой строки переменной FThreadStateInfo происходит две вещи: </span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>а) выделяется новая область памяти под
  новую строку (с помощью функции менеджера памяти </span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>GetMem</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>б) освобождается память, занятая
  старой строкой (с помощью функции менеджера памяти </span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>FreeMem</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>). Память
  будет освобождена при условии, если старая строка нигде больше не
  используется, т.е. у неё нулевой счётчик ссылок.</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Главный поток при чтении незащищенной
  строки FThreadStateInfo может попасть в такую ситуацию, при которой:</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>а) память под старую строку уже
  освобождена с помощью </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>FreeMem</span><span style='font-size:
  14.0pt;font-family:"Times New Roman","serif"'>;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>б) в переменной FThreadStateInfo всё
  ещё хранится указатель на старую строку. При попытке обращения к строке по
  недействительному указателю возникает ошибка «Invalid pointer operation».</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Применение критической секции
  избавляет нас от этой проблемы.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535559">5.4 Использование
функции </a><span lang=EN-US>SendMessage</span><span lang=EN-US> </span>для
передачи данных в основной поток</h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Мы уже рассмотрели возможность
использования метода Synchronize для вызова указанного метода-процедуры в
контексте основного потока. Также в </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>существует
альтернативный механизм передачи данных в основной поток, основанный на
передаче и обработке оконных сообщений. Суть этого механизма состоит в том, что
дополнительный поток вызывает стандартную </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Windows</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-функцию
SendMessage (по ней я не планирую давать подробную информацию, поэтому читайте
официальную документацию), а в классе формы (например, </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TForm</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>1)
реализуется метод обработки соответствующего оконного сообщения (этот метод
вызывается в контексте основного потока). Вызов функции SendMessage является
блокирующим, поэтому работа дополнительного потока будет приостановлена в точке
вызова функции SendMessage до тех пор, пока не завершится работа метода
обработки оконного сообщения.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Функция SendMessage объявлена следующим
образом:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>function
SendMessage(hWnd: HWND; Msg: UINT; wParam: WPARAM; lParam: LPARAM): LRESULT;
stdcall;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>При вызове данной функции мы должны
передать </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Handle</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>компонента,
в котором реализован обработчик сообщения (параметр </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>hWnd</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>),
код сообщения (параметр </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Msg</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>),
а также, если Вам это необходимо, параметры (</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>wParam</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>lParam</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Параметры </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>wParam</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
и </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>lParam</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'> являются
целочисленными (32 или 64 бита в зависимости от разрядности разрабатываемого
приложения), поэтому с их помощью Вы можете передать а) целое число; б) ссылку
на любой объект любого класса; в) указатель на любой блок выделенной памяти.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Метод обработки оконного сообщения
объявляется с указанием ключевого слова </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>message</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>и
кода сообщения. Пример</span><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'> </span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>объявления</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure UMProcessMyMessage(var Msg: TMessage); message
WM_USER + 1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif";color:red'>Внимание! </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Если Вы
  вводите свои (нестандартные коды сообщений), то необходимо использовать коды
  не менее WM_USER, например:<br>
  WM_USER + 1, WM_USER + 2, WM_USER + 3 и т.д. </span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Рекомендуется заводить константы для
нестандартных оконных сообщения (иначе Вы быстро забудете, что у Вас означает WM_USER
+ 1). Пример объявления такой константы:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>const</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>UM</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>_</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>PROCESS</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>_</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>MY</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>_</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>MESSAGE</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> = </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>WM</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>_</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>USER</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> + 1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Префикс «</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>UM</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>_»
является сокращением от «</span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>User</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>message</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>».</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже представлен исходный код модуля из
примера </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ex</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>9:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>unit Ex9Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Windows, Messages, SysUtils, Variants, Classes, Graphics,
Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Dialogs, StdCtrls, MTUtils, ComCtrls;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>const</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  UM_PROGRESS_INIT   = WM_USER + 1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  UM_PROGRESS_CHANGE = WM_USER + 2;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TProgressData = class</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    CurrValue: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    CalcResult: Int64;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadStateInfo: string;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ProgressData: TProgressData;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FFormHandle: THandle;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FMaxValue: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    constructor Create(AMaxValue: Integer; AFormHandle:
THandle);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    destructor Destroy; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnRunInParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ProgressBar1: TProgressBar;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Label1: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    labResult: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    edMaxValue: TEdit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Label2: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    labThreadStateInfo: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FMyThread: TMyThread;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure UMProgressInit(var Msg: TMessage); message
UM_PROGRESS_INIT;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure UMProgressChange(var Msg:TMessage); message
UM_PROGRESS_CHANGE;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{$R *.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // Уничтожаем запущенный поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  if Assigned(FMyThread) then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FreeAndNil(FMyThread);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>// Создаём и запускаем новый поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FMyThread := TMyThread.Create(StrToInt(edMaxValue.Text),
Handle);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FMyThread.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.UMProgressChange(var Msg: TMessage);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressData: TProgressData;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressData := TProgressData(Msg.WParam);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressBar1.Position      := ProgressData.CurrValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  labResult.Caption          :=
IntToStr(ProgressData.CalcResult);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  labThreadStateInfo.Caption := ProgressData.ThreadStateInfo;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.UMProgressInit(var Msg: TMessage);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  MaxValue: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  MaxValue := Msg.WParam;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressBar1.Max := MaxValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressBar1.Position := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  labResult.Caption := '0';</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  labThreadStateInfo.Caption := 'Start';</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>constructor TMyThread.Create(AMaxValue: Integer; AFormHandle:
THandle);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  inherited Create(False);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FMaxValue := AMaxValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FFormHandle := AFormHandle;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressData := TProgressData.Create;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>destructor TMyThread.Destroy;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  //ProgressData.Free; - НЕЛЬЗЯ ТУТ!</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  inherited;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressData.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  CurrVal: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // Выставляем параметры компонента ProgressBar1</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  SendMessage(FFormHandle, UM_PROGRESS_INIT, FMaxValue, 0);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ThreadWaitTimeout(Self, 1000); // Просто пауза 1 сек.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  CurrVal := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // Выполняем некоторые вычисления</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while CurrVal &lt; FMaxValue do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    if Terminated then Break;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Inc(CurrVal);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ProgressData.CurrValue := CurrVal;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ProgressData.CalcResult := ProgressData.CalcResult +
CurrVal;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ProgressData.ThreadStateInfo := Format('Progress: %f%%',</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>[</span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>CurrVal</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> / </span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>FMaxValue</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> * 100]);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
// Обновление прогресса выполняется только 1 раз из 10000</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>if CurrVal mod 10000 = 0 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      SendMessage(FFormHandle, UM_PROGRESS_CHANGE, WPARAM(ProgressData),
0);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Обновляем прогресс в конце вычислений</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>SendMessage(FFormHandle, UM_PROGRESS_CHANGE,
WPARAM(ProgressData), 0);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В данном примере используется два
способа передачи данных в основной поток с использованием функции SendMessage.
В первом способе (код UM_PROGRESS_INIT) целочисленное значение FMaxValue
передаётся в качестве параметра </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>wParam</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Во втором способе (код UM_PROGRESS_CHANGE) передаётся ссылка на объект класса TProgressData
в качестве параметра </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>wParam</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Для передачи ссылки на объект в качестве параметра </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>wParam</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
необходимо выполнять приведение типа к WPARAM следующим образом:
WPARAM(ProgressData). С </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>lParam</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>ситуация
аналогична (тип </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>LPARAM</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Объект ProgressData создаётся в
конструкторе TMyThread.Create, а уничтожается в деструкторе TMyThread.Destroy. Для
использования объекта в методе TForm1.UMProgressChange требуется использовать
приведение типа к TProgressData: ProgressData := TProgressData(Msg.WParam).</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Обратите внимание, что уничтожать
  объект ProgressData в деструкторе TMyThread.Destroy следует после того, как
  был вызван </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>inherited</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>. Если
  уничтожать объект до вызова </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>inherited</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>, то при
  уничтожении объекта-потока (FMyThread.Free) будет возникать ошибка </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Access</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>violation</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> в том случае,
  если Вы попробуете закрыть программу, не дожидаясь окончания вычислений. Это
  объясняется следующим образом:</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>1) при вызове FMyThread.Free
  происходит вызов деструктора TMyThread.Destroy, в котором вызывается inherited;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>2) при вызове inherited срабатывает родительский
  деструктор </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>TThread</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>. Destroy, в
  котором выставляется флаг </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Terminated</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>3) внутри метода TMyThread.Execute всё
  ещё продолжается выполняться код и проверяется флаг </span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Terminated</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>. Объект ProgressData
  к этому моменту должен существовать, иначе при обращении к нему возникнет </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Access</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Violation</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Обратите внимание, что при уничтожении
объекта-потока (FMyThread.Free) главный поток не зависает, несмотря на то, что
последней командой в методе TMyThread.Execute является SendMessage. Это
происходит благодаря тому, что в деструкторе потока есть код, который
обеспечивает предотвращение взаимной блокировки.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Функцией </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>SendMessage</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Вы можете
  пользоваться только при разработке программы под </span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Windows</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>. Данная
  функция может быть недоступна при программировании под другие операционные
  системы! Универсальным (кроссплатформенным) способом передачи данных в
  основной поток является Synchronize.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535560">5.5 Использование
функции </a><span lang=EN-US>PostMessage</span><span lang=EN-US> </span>для
передачи очереди сообщений в основной поток</h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Функция </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>PostMessage</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>очень
похожа на функцию </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>SendMessage</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>и
также входит в состав </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Windows</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>API</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>. Однако существует принципиальная
разница: функция </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>PostMessage</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>не
является блокирующей, т.е. она вернёт управление сразу же после вызова. Из-за
такой особенности Вы не всегда сможете использовать функцию </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>PostMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
в тех же сценариях, что и </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>SendMessage</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>или
Synchronize. При использовании функции </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>PostMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
следует соблюдать осторожность, поскольку Вы можете столкнуться со следующими проблемами,
которые не могут возникнуть при использовании </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>SendMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) переполнение оконной очереди
сообщений из-за слишком частого вызова функции </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>PostMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(т.е. главный поток попросту не сможет обрабатывать сообщения из оконной
очереди с той же скоростью, с которой сообщения добавляются в оконную очередь).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) задержка визуализации актуальной
информации, поскольку обработка сообщений из оконной очереди выполняется по
принципу </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>FIFO</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>. Допустим,
дополнительный поток решил передать в основной поток 100 сообщений с помощью </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>PostMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
а главный поток при обработке каждого оконного сообщения выполняет запрос к
базе данных, длительность которого составляет 1 секунду. Это приведёт к тому, что
актуальная информация будет показана пользователю лишь спустя 100 секунд.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) обращение к недействительному
указателю и, как следствие, ошибка «</span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Invalid</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>pointer</span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'> </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>operation</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>»
либо «</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Access</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>violation</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>». Такую ошибку легко
получить, если дополнительный поток выполнит создание объекта, затем он вызовет
функцию </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>PostMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(передаст в неё ссылку на объект), а затем сразу же уничтожит созданный ранее
объект. Ошибка возникнет в основном потоке, как только в нём произойдет вызов
обработчика оконного сообщения и он попытается обратиться к объекту по
недействительному указателю.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Пример использования функции </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>PostMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
для передачи данных в очередь сообщений основного потока находится в папке «</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>10».
К сожалению, объём кода в примере получился большим, поэтому считаю, что нет
необходимости приводить здесь весь пример целиком. Ниже приведён код метода TMyThread.Execute,
а также код обработчика сообщения UMProgressChange:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  CurrVal: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  CalcResult: Int64;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ThreadStateInfo: string;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressData: TProgressData;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
CurrVal := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
CalcResult := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Выполняем некоторые вычисления</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>while CurrVal &lt; FMaxValue do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    if Terminated then Break;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Inc(CurrVal);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    CalcResult := CalcResult + CurrVal;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadStateInfo := Format('Progress: %f%%', [CurrVal /
FMaxValue * 100]);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>// Обновление прогресса выполняется только 1 раз из
10000</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>if CurrVal mod 10000 = 0 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Создаём</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>объект</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
ProgressData </span><span style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>непосредственно</span><span style='font-size:10.0pt;line-height:
107%;font-family:"Courier New"'> </span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>перед</span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
PostMessage</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      ProgressData:=TProgressData.Create(CurrVal,CalcResult,ThreadStateInfo);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      PostMessage(FFormHandle, UM_PROGRESS_CHANGE,
WPARAM(ProgressData), 0);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Inc(PostMessageCount);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Обновляем прогресс в конце вычислений</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>ProgressData := TProgressData.Create(CurrVal, CalcResult,
ThreadStateInfo);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  PostMessage(FFormHandle, UM_PROGRESS_CHANGE,
WPARAM(ProgressData), 0);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Inc(PostMessageCount);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Этот флаг необходим, чтобы главный поток мог убедиться, что</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// доп. поток отработал корректно до последнего</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>EndWork := True;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.UMProgressChange(var Msg: TMessage);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressData: TProgressData;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressData := TProgressData(Msg.WParam);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ProgressBar1.Position      := ProgressData.CurrValue;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  labResult.Caption          :=
IntToStr(ProgressData.CalcResult);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  labThreadStateInfo.Caption := ProgressData.ThreadStateInfo;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Inc(FPostMsgProcessCount);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>// Здесь необходимо уничтожить объект TProgressData:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
ProgressData.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Обратите внимание на то, что объект ProgressData
создаётся в методе TMyThread.Execute, а уничтожается в методе UMProgressChange.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В окне программы отображается количество
вызовов функции PostMessage и количество вызовов обработчика UMProgressChange.
В данном примере вызов функции PostMessage выполняется 1 раз из 10000. </span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Если производить вызов 1 раз из 100
  (или чаще), то будет происходить переполнение оконной очереди сообщений и
  обработчик UMProgressChange будет срабатывать меньшее количество раз по
  сравнению с количеством вызовов функции PostMessage. Для нашего примера это
  плохо тем, что будет происходить утечка памяти, поскольку перед каждым
  вызовом функции PostMessage выполняется создание объекта ProgressData. Если
  обработчик UMProgressChange будет срабатывать реже, чем PostMessage, то не
  все объекты ProgressData будут уничтожены.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535561">5.6 Использование списка
</a><span lang=EN-US>TThreadList</span> для передачи очереди данных в основной
поток</h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>При разработке многопоточных программ
очень часто возникает необходимость организовать передачу очереди данных между
потоками. Для организации такой очереди можно использовать массивы или списки.
Очень важно, чтобы массив / список был защищён от одновременного доступа из
нескольких потоков. В простейшем случае мы можем защитить массив / список с
помощью критической секции. В </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>имеются
специализированные классы, позволяющие организовать очередь сообщений для
обмена данными между потоками. Одним из таких классов является TThreadList –
потокобезопасный список. По сути, это обычный </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TList</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
в котором используется критическая секция. Он не допускает одновременного
доступа к списку из разных потоков.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В примере </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>11
будет решена такая задача: несколько дополнительных потоков будут генерировать
текстовую информацию (события), а главный поток будет отображать дату, время,
номер потока и текст события в компоненте </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TListBox</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже представлен листинг кода примера </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>11:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>unit Ex11Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Windows, Messages, SysUtils, Variants, Classes, Graphics,
Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Dialogs, StdCtrls, MTUtils, ComCtrls, ExtCtrls, StrUtils,
Contnrs;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TLogMessage = class</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadId: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    EventTime: TDateTime;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    EventText: string;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    constructor Create(AThreadId: Integer; AEventTime:
TDateTime; </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      AEventText: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure LogEvent(s: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  protected</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnRunInParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Timer1: TTimer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Button1: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ListBox1: TListBox;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Timer1Timer(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormCreate(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Button1Click(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FList: TObjectList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ThreadCounter: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  EventList: TThreadList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{$R *.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Создаём и запускаем новый поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FList.Add(TMyThread.Create(False));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.Button1Click(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FList.Clear;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormCreate(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FList := TObjectList.Create;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  EventList := TThreadList.Create;;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FList.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// В списке могут остаться элементы. Это не страшно, поскольку</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// выполняется выход из программы</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>EventList.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.Timer1Timer(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  L, TmpList: TList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  I: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  m: TLogMessage;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Cnt: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Определяем</span><span lang=EN-US style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>, </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>есть</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>ли</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>элементы</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>в</span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> </span><span
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>списке</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
EventList</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  L := EventList.LockList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Cnt := L.Count;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  EventList.UnlockList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  if Cnt = 0 then Exit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TmpList := TList.Create;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  try</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    L := EventList.LockList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>try</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
// Переносим все элементы во временный список</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>TmpList.Assign(L);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      // </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>Очищаем</span><span style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'> </span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>список</span><span
lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>
EventList</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>L.Clear;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
finally</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
// Как можно быстрее снимаем блокировку списка</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
EventList.UnlockList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
// Дальше обрабатываем элементы из временного списка</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>for I := 0 to TmpList.Count - 1 do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      m := TLogMessage(TmpList[I]);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      if ListBox1.Count &lt; 50000 then</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        ListBox1.Items.Add(Format('%s [T:%d] - %s',</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>          [FormatDateTime('hh:nn:ss.zzz', m.EventTime),
m.ThreadId, m.EventText]));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>// Здесь необходимо уничтожить объект TLogMessage</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>     
m.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ListBox1.ItemIndex := ListBox1.Count - 1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  finally</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    TmpList.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  I: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  I := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  LogEvent('Thread start');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while not Terminated do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Inc(I);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    LogEvent('Event #' + IntToStr(I));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadWaitTimeout(Self, 1000);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  LogEvent('Thread stop');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.LogEvent(s: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  L: TList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  m: TLogMessage;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  m := TLogMessage.Create(GetCurrentThreadId, Now, s);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  L := EventList.LockList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  L.Add(m);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  EventList.UnlockList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TLogMessage }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>constructor TLogMessage.Create(AThreadId: Integer; AEventTime:
TDateTime;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  AEventText: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ThreadId  := AThreadId;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  EventTime := AEventTime;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  EventText := AEventText;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В данном примере используется таймер </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TTimer</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
который срабатывает каждые 100 мс. В обработчике таймера TForm1.Timer1Timer
выполняются следующие действия:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1) проверяется количество элементов в
списке EventList;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2) если в списке EventList есть
элементы, то они копируются во временный список TmpList, а из списка EventList
все элементы удаляются;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3) элементы из списка TmpList выводятся
в список ListBox1.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Обратите внимание, как следует
пользоваться объектом класса TThreadList. Для начала необходимо выполнить
блокировку списка с помощью метода LockList и запомнить ссылку на объект класса
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>TList</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>: </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>L</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
:= EventList.LockList. Далее с полученной ссылкой вы можете производить любые
действия (добавление, удаление, очистка элементов списка </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TList</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).
После того, как Вы закончили работать со списком, необходимо его
разблокировать. Для этого следует вызвать метод UnlockList.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Не следует устанавливать
  блокировку на длительное время! Старайтесь проектировать свой код таким
  образом, чтобы длительность блокировки была как можно меньше. </span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Обратите внимание, что в обработчике TForm1.Timer1Timer
вызов методов LockList / UnlockList выполняется дважды. Сначала мы блокируем
список для доступа к количеству элементов (свойство </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TList</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Count</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).
При этом мы не используем конструкцию </span><span lang=EN-US style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>try</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>..</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>finally</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Далее мы блокируем список для копирования элементов списка во временный список TmpList
и в этом случае мы используем конструкцию </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>try</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>..</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>finally</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Решение о том, нужно ли
  использовать конструкцию </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>try</span><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>..</span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>finally</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> в каждом
  конкретном случае, зависит от того, какова вероятность возникновения ошибки (</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>exception</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>) между LockList
  и UnlockList. Если код очень простой и ошибка возникнуть не может (например,
  при обращении к свойству </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Count</span><span style='font-size:
  14.0pt;font-family:"Times New Roman","serif"'>), то использовать конструкцию </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>try</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>..</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>finally</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> нет
  необходимости. В противном случае рекомендуется подстраховаться и
  использовать конструкцию </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>try</span><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>..</span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>finally</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>, чтобы
  гарантировать, что метод UnlockList будет вызван при любой ситуации. Также
  рекомендуется использовать </span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>try</span><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>..</span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>finally</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> для улучшения
  визуального восприятия структуры кода в случае значительного количества строк
  кода между LockList и UnlockList. В некоторых задачах (например, при
  математических вычислениях) следует по возможности избегать использования
  конструкций </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>try</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>..</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>finally</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>и </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>try</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>..</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>except</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>, т.к. они
  могут нести значительные накладные расходы.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В данном примере используется функция GetCurrentThreadId
из состава </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Windows</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>API</span><span style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>. Данная функция возвращает
идентификатор того потока, который вызвал эту функцию. Идентификатор каждого
потока в операционной системе является уникальным, вне зависимости от того,
какой процесс его создал.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535562">5.7 Использование метода
</a><span lang=EN-US>TThread</span>.<span lang=EN-US>Synchronize</span><span
lang=EN-US> </span>для передачи данных в основной поток – вариант с
использованием анонимной процедуры</h2>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В современных версиях Delphi можно
передавать анонимную процедуру при вызове метода TThread.Synchronize. </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Анонимная процедура / функция, как
следует из названия, не имеет имени и может использоваться в качестве параметра
при вызове другой процедуры/функции. Механизм работы анонимных функций довольно
сложный и у меня нет возможности его здесь описывать (в этом нет ничего
страшного, поскольку в интернете есть много информации на данную тему). Хочу
отметить, что анонимные функции давно являются нормой в современных языках
программирования. Термин «анонимная функция» используется в </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Delphi</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(на мой взгляд, это не очень удачное название, поскольку очень часто объявление
такой функции присваивается переменной, а переменная имеет вполне конкретное
имя). В других языках программирования данный механизм может называться иначе,
например: делегат, замыкание, лямбда. В независимости от того, как этот
механизм называется в том или ином языке, существует одна очень важная
особенность: анонимная функция «видит» все переменные, которые являются внешними
по отношению к ней. В случае передачи анонимной процедуры в метод Synchronize,
её вызов будет произведён в контексте главного потока, однако внутри анонимной
процедуры мы вполне можем использовать локальные переменные, которые были
объявлены в методе Execute.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Ниже представлен простейший пример
вызова метода Synchronize с анонимной процедурой из метода Execute:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
CurTime := Now; // Запоминаем время ДО вызова </span><span lang=EN-US
style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>Synchronize</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Synchronize(</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      Form1.labLabLastThreadTime.Caption :=</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>'Последний поток был запущен: ' +
DateTimeToStr(CurTime);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
end);</span></p>

<p class=MsoNormal style='text-indent:35.45pt'><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<h2 style='text-indent:35.45pt'><a name="_Toc45535563">5.8 Использование метода
TThread.Queue для передачи данных в основной поток</a></h2>

<p class=MsoNormal style='text-align:justify;text-indent:35.45pt'><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>В современных версиях Delphi  имеется
ещё один метод, позволяющий произвести вызов заданной процедуры в контексте
основного потока: TThread.Queue. Данный метод имеет параметры, аналогичные
методу TThread.Synchronize. Основное отличие от метода Synchronize заключается
в том, что метод Synchronize является блокирующим, а метод Queue блокирующим не
является. Также как и функция PostMessage, метод Queue возвращает управление немедленно.
Метод Queue, как и метод Synchronize, может принимать в качестве параметра:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>а) метод (процедуру);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>б) анонимную процедуру;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>в) обычную процедуру (в этом случае
компилятор создаёт анонимную процедуру, из которой производится вызов обычной
процедуры).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Суть работы метода состоит TThread.Queue
в следующем:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1. Метод Queue добавляет в конец списка </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>SyncList</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(глобальная переменная типа </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>TList</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>)
информацию, необходимую для вызова  переданной ей процедуры.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. Основной поток периодически проверяет
наличие элементов в списке </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>SyncList</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Если в списке обнаружен элемент, то производится запуск процедуры, хранящейся в
списке.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3. Метод TThread.Queue, вызванный в
дополнительном потоке, вернёт управление немедленно, т.е. он не будет
дожидаться, когда основной поток выполнит запуск заданной процедуры.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>С появлением метода TThread.Queue многие
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>Delphi</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>-программисты стали
гораздо реже использовать старые способы взаимодействия с основным потоком (Synchronize,
</span><span lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:
"Times New Roman","serif"'>SendMessage</span><span style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>, </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>PostMessage</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).
Вероятная причина этого заключается в том, что дополнительный поток не
блокируется при вызове Queue, и никак не зависит от того, насколько сильно в
данный момент загружен главный поток программы. Метод TThread.Queue можно
использовать в большинстве тех случаев, когда раньше приходилось использовать
метод Synchronize. Если Вы используете метод Queue, то должны учитывать, что
при вызове заданной процедуры в контексте основного потока дополнительный поток
продолжает выполняться и существует риск одновременного обращения к объекту /
структуре / массиву / строке из главного и из дополнительного потока. Мы
помним, что в некоторых случаях мы должны защищать сложные объекты от
одновременного доступа, например, с помощью критической секции, либо с помощью
механизма </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>TMonitor</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Пример </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Ex</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>12
демонстрирует применение метода TThread.Queue для журналлирования событий,
происходящих в дополнительном потоке.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>unit Ex12Unit;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>interface</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>uses</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Windows, Messages, SysUtils, Variants, Classes, Graphics,
Controls, Forms,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Dialogs, StdCtrls, MTUtils, ComCtrls, ExtCtrls, StrUtils,
Contnrs,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Generics.Collections;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>type</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TMyThread = class(TThread)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure LogEvent(EventText: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  protected</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Execute; override;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TForm1 = class(TForm)</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnRunInParallelThread: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Button1: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ListBox1: TListBox;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    labLabLastThreadTime: TLabel;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    btnClearListBox: TButton;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure FormCreate(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure Button1Click(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure btnClearListBoxClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  private</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Private declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    FList: TObjectList&lt;TMyThread&gt;;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  public</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    { Public declarations }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  Form1: TForm1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>implementation</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{$R *.dfm}</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnClearListBoxClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ListBox1.Clear;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.btnRunInParallelThreadClick(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Создаём и запускаем новый поток</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>FList.Add(TMyThread.Create(False));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.Button1Click(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  t: TMyThread;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  for t in FList do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>t.Terminate; // Сообщаем потокам о необходимости
завершаться</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
FList.Clear; // Уничтожаем потоки</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormCreate(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FList := TObjectList&lt;TMyThread&gt;.Create;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TForm1.FormDestroy(Sender: TObject);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  FList.Free;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>{ TMyThread }</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.Execute;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  I: Integer;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  CurTime: TDateTime;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>CurTime</span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'> := </span><span lang=EN-US style='font-size:10.0pt;
line-height:107%;font-family:"Courier New"'>Now</span><span style='font-size:
10.0pt;line-height:107%;font-family:"Courier New"'>; // Запоминаем время ДО вызова
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Queue</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>Queue(</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      Form1.labLabLastThreadTime.Caption :=</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>'Последний поток был запущен: ' +
DateTimeToStr(CurTime);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>   
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  LogEvent('Thread start');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  I := 0;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  while not Terminated do</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    Inc(I);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    LogEvent('Event #' + IntToStr(I));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    ThreadWaitTimeout(Self, 500);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  LogEvent('Thread stop');</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>procedure TMyThread.LogEvent(EventText: string);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>var</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  ThreadId: Cardinal;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  EventTime: TDateTime;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
// Запоминаем ID потока и текущее время ДО вызова Queue</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'> 
</span><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>ThreadId := GetCurrentThreadId;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  EventTime := Now;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>  TThread.Queue(nil,</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    procedure</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    begin</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      Form1.ListBox1.Items.Add(Format('%s [T:%d] - %s',</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>        [FormatDateTime('hh:nn:ss.zzz', EventTime), ThreadId,
EventText]));</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>      Form1.ListBox1.ItemIndex := Form1.ListBox1.Count - 1;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span lang=EN-US style='font-size:10.0pt;line-height:107%;font-family:
"Courier New"'>    </span><span style='font-size:10.0pt;line-height:107%;
font-family:"Courier New"'>end);</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:10.0pt;line-height:107%;font-family:"Courier New"'>end.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Обратите внимание на следующие
особенности данного примера:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1. В методе TMyThread.LogEvent при
вызове метода Queue используется следующая форма: TThread.Queue(</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>nil</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
АнонимнаяПроцедура). Благодаря тому, что используется значение </span><b><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>nil</span></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
анонимная процедура <b>не ассоциируется</b> с объектом дополнительного потока.
Благодаря этому <b>гарантируется</b>, что основной поток обработает все вызовы Queue
с параметром </span><b><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>nil</span></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Даже если дополнительный поток 1000 раз подряд вызовет метод Queue, а главный
поток вызовет метод </span><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>Free</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>для
объекта-потока, не успев обработать все вызовы Queue, объект потока будет
уничтожен, но главный поток всё равно обработает все вызовы.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Следует быть предельно внимательным
  при использовании такой формы вызова метода Queue. Дело в том, что если в
  анонимной процедуре будут обращения к полям / свойствам / методам объекта-потока,
  то в ситуации досрочного уничтожения объекта потока произойдёт ошибка доступа
  к памяти (например, «</span><span lang=EN-US style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Invalid</span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>pointer</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>operation</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>», «</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Access</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>violation</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>» либо «</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Out</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>of</span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>memory</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>») при вызове
  процедуры в контексте основного потока.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. В анонимной процедуре, которая
является параметром метода Queue в методе TMyThread.LogEvent, отсутствуют
обращения к полям / свойствам / методам объекта-потока. Реализация данной
анонимной процедуры никак не привязана к состоянию дополнительного потока. В
ней не произойдет ошибки, даже если объект-поток будет уничтожен раньше времени.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3. В методе TMyThread.LogEvent все
данные, которые используются в анонимной процедуре, формируются <b>заранее</b>.
В анонимной процедуре используются переменные EventTime, ThreadId, EventText.
Переменные EventTime и ThreadId объявляются в методе TMyThread.LogEvent и им
присваиваются значения <b>до</b> вызова Queue. Переменная EventText является
параметром метода LogEvent, т.е. её значение также <b>сформировано</b> до
вызова Queue.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>К сожалению, в метод Queue невозможно
  передать дополнительные параметры, которые в дальнейшем могли бы использоваться
  при вызове анонимной процедуры. Но благодаря тому, что переменные EventTime, ThreadId,
  EventText объявлены в методе LogEvent и их значения сформированы до вызова Queue,
  то мы можем их рассматривать как параметры вызова анонимной процедуры. При
  каждом вызове метода Queue (внутри метода LogEvent) переменные EventTime, ThreadId,
  EventText будут «захватываться», а затем использоваться при вызове анонимной
  процедуры в основном потоке.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>4. Метод Queue вызывается <b>из отдельного
</b>метода TMyThread.LogEvent. Это очень важно! Если мы хотим эмулировать
передачу параметров в анонимную функцию, то вызов метода Queue лучше выполнять
из отдельного метода. Например:</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>procedure TMyThread.CallMyFuncInMainThread(param1:
  Integer; param2: string);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>begin</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  TThread.Queue(nil,</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    procedure</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    var</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      s: string;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    begin</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      s := Format('param1=%d; param2=%s', [param1,
  param2]);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      Form1.ListBox1.Items.Add(s);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    end);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>end;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>&nbsp;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span style='font-size:14.0pt;font-family:"Times New Roman","serif"'>Вызов</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>из</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> <span
  lang=EN-US>Execute: </span></span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  I := 111;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  sVal := 'Text 1';</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  CallMyFuncInMainThread(I, sVal);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  I := 222;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  sVal := 'Text 2';</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  CallMyFuncInMainThread(I, sVal);</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify'><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Благодаря
этому, при передаче анонимной процедуры в метод Queue происходит захват
параметров и переменных отдельного метода. Если бы мы в методе </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>выполнили
2 раза подряд вызов Queue вместо CallMyFuncInMainThread, например:</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span style='font-size:10.0pt;font-family:"Courier New"'> 
  </span><span lang=EN-US style='font-size:10.0pt;font-family:"Courier New"'>I
  := 111;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  sVal := 'Text 1';</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  TThread.Queue(nil,</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    procedure</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    var</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      s: string;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    begin</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      s := Format('param1=%d; param2=%s', [I,
  sVal]);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      Form1.ListBox1.Items.Add(s);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    end);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>&nbsp;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  I := 222;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  sVal := 'Text 2';</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>  TThread.Queue(nil,</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    procedure</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    var</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      s: string;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    begin</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      s := Format('param1=%d; param2=%s', [I,
  sVal]);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>      Form1.ListBox1.Items.Add(s);</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'><span lang=EN-US style='font-size:10.0pt;
  font-family:"Courier New"'>    end);</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>то для обоих вызовов анонимной процедуры
использовались бы одни и те же значения захваченных переменных </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>I</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>и
sVal. В этом случае в ListBox1 будет добавлено 2 одинаковых строки:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>param1=222; param2=Text 2</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>param1=222; param2=Text 2</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Конечно, если после первого вызова Queue
поставить паузу (например, </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Sleep</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>(100)),
то главный поток скорее всего успеет выполнить вызов первой анонимной процедуры
с правильными значениями 111 и «</span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>Text</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
1».</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>5. В методе </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
присутствует вызов метода Queue, в который передаётся анонимная процедура,
которая записывает в компонент labLabLastThreadTime время запуска
дополнительного потока. Обратите внимание, что здесь используется форма вызова
без указания </span><b><span lang=EN-US style='font-size:14.0pt;line-height:
107%;font-family:"Times New Roman","serif"'>nil</span></b><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Это означает, что анонимная процедура будет ассоциирована с объектом потока,
что в свою очередь означает, что при уничтожении потока необработанный главным
потоком вызов Queue (вернее, информация, необходимая для вызова процедуры),
будет удалена из очереди отложенных вызовов. В данном случае нет никаких рисков
по следующим причинам:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>а) метод Queue вызывается в начале
метода </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Execute</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>, поток не
завершится сразу же после данного вызова Queue (пользователь просто не успеет
так быстро нажать кнопку «Остановить потоки»), значит главный поток успеет
обработать данный вызов Queue.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>б) даже если главный поток не успеет
выполнить отложенный вызов процедуры, а дополнительный поток по каким-то
причинам будет уничтожен, необходимая для вызова отложенной процедуры
информация попросту будет удалена из очереди. В данном случае это не приведёт к
негативным последствиям, поскольку процедура не выполняет никакой ответственной
работы.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Будьте внимательны при
  использовании формы вызова метода Queue без указания </span><b><span
  lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>nil</span></b><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>! В этом
  случае вызов отложенной процедуры может не произойти (если дополнительный
  поток был уничтожен до того, как главный поток произвёл вызов процедуры). В
  некоторый случаях это может приводить к некорректной работе программы (если
  программа написана таким образом, что вызов отложенной процедуры является
  обязательным), либо к утечке памяти (если отложенная процедура должна
  освободить память, выделенную перед вызовом метода Queue).</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>6. В методе </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Execute</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
организована пауза 500 мс между вызовами метода LogEvent в цикле.</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Внимание! Не следует вызывать метод Queue
  слишком часто. Если дополнительный поток будет вызывать метод Queue слишком
  часто, то главный поток программы не будет успевать обрабатывать элементы
  очереди </span><span lang=EN-US style='font-size:14.0pt;font-family:"Times New Roman","serif"'>SyncList</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>, в результате
  чего размер списка отложенных вызовов </span><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>SyncList</span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> будет
  увеличиваться, а интерфейс пользователя будет выглядеть зависшим.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>7. В данном примере для хранения ссылок
на объекты-потоки используется список, объявленный следующим образом: FList:
TObjectList&lt;TMyThread&gt;. Это позволяет избавиться от необходимости
использовать операцию приведения типа (как при использовании обычного TObjectList).</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Для исследования работы метода Queue вы
можете использовать пример Ex12Full. Он наглядно демонстрирует проблему
обработки отложенных вызовов при уничтожении дополнительных потоков. Его
особенности следующие:</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1. Понижается приоритет дополнительного
потока с помощью кода Priority := tpLowest. Это означает, что потоку будет
отводиться гораздо меньше процессорного времени, чем обычно. Это необходимо для
того, чтобы код, который выполняется в конце метода Execute (цикл от 1 до 100)
занимал процессор на минимальное количество времени. По этим же причинам в
данном цикле дополнительно вызывается Sleep(0). Благодаря этому главный поток
начнёт обработку очереди отложенных вызовов раньше, чем завершится цикл, т.е.
что-нибудь из этого цикла скорее всего попадёт в </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>ListBox</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. Переменной ThreadWaitTimeoutSleepTime,
которая используется в процедуре ThreadWaitTimeout, выставляется значение «1».
Это означает, что процедура ThreadWaitTimeout завершит свою работу сразу же,
как только объекту потока будет произведён вызов метода </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Terminate</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.
Это важно в том случае, если Вы запустили несколько потоков. Благодаря этому у
всех потоков цикл от 1 до 100 будет выполняться практически одновременно.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>3. В анонимной процедуре, которая
реализована в методе TMyThread.LogEvent, вызывается </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Sleep</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>(5).
Это необходимо для того, чтобы главный поток не мог сразу (за свой квант
времени) обработать все сообщения из очереди.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>5. Реализовано 2 способа вызова метода TThread.</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>Queue</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>в
методе </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>TMyThread</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>LogEvent</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>:
1) ассоциировать анонимную процедуру с объектом потока; 2) не ассоциировать.
Если выбран способ 1, то при уничтожении потоков в список </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>ListBox</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
попадут не все строки от 1 до 100. Это означает, что при уничтожении
объекта-потока произошло удаление всех отложенных вызовов (т.е. записей из
списка SyncList), которые ассоциированы с объектом потока, но ещё не обработаны
главным потоком. Если выбран способ 2, то в </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>ListBox</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
попадут все строки от 1 до 100.</span></p>

<h1 style='text-indent:35.45pt'><a name="_Toc45535564">6. Где можно и где
нельзя создавать и уничтожать потоки</a></h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Данные замечания актуальны при
разработке программ под Windows. Существует ряд мест, где не следует создавать
либо уничтожать потоки.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>1. Создавать потоки не следует в секции initialization
(как в EXE, так и в DLL). По моему опыту создание дополнительных потоков в
секции initialization EXE-модуля (не важно, в каком </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>pas</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-файле)
приводит к снижению стабильности приложения. Грубо говора, один раз из 100
возникает сбой при запуске приложения.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>2. Не следует уничтожать потоки в секции
finalization DLL-библиотеки. Если Вы попытаетесь это сделать, то, скорее всего
программа зависнет (это происходит из-за особенностей выгрузки </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>DLL</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-библиотек
в ОС </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Windows</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>). </span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Если Вы разрабатываете </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>DLL</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>-библиотеку,
в которой используются дополнительные потоки, то рекомендую реализовать в ней
две экспортные функции – одну для создания необходимых объектов в библиотеке
(например, </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>CreateLibrary</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>),
вторая для уничтожения созданных объектов (например, </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>DestroyLibrary</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>).
В этом случае код создания потоков можно разместить в </span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>CreateLibrary</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
(либо создавать их позже), а код уничтожения объектов потоков разместить в </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>DestroyLibrary</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.</span></p>

<h1 style='text-indent:35.45pt'><a name="_Toc45535565">7. Коротко о приоритетах
потоков в </a><span lang=EN-US>Windows</span></h1>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>При разработке многопоточной программы
для </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Windows</span><span lang=EN-US
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>
</span><span style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>существует
возможность назначать потоку относительный приоритет (свойство </span><span
lang=EN-US style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>TThread</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>.Priority).
По умолчанию используется приоритет tpNormal. Тип TThreadPriority объявлен
следующим образом:</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>{$IFDEF
  MSWINDOWS}</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'> 
  TThreadPriority = (tpIdle, tpLowest, tpLower, tpNormal, tpHigher, tpHighest,</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span lang=EN-US
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>    </span><span
  style='font-size:14.0pt;font-family:"Times New Roman","serif"'>tpTimeCritical)
  platform;</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>{$ENDIF MSWINDOWS}</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Обычно программисту нет смысла
  изменять приоритеты потоков. Приоритет потока никак не влияет на скорость
  исполнения программного кода. Приоритет потока никак не влияет на размер
  кванта времени. Относительный приоритет потока работает только в рамках
  процесса и никак не влияет на выделение квантов времени потокам, которые
  работают в других процессах.</span></p>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Изменять приоритет потока не имеет
  никакого смысла, если выполняется задача, в которой основное время уходит на
  ожидание какого-либо события.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Если в Вашей программе работают 2
потока, у одного приоритет </span><span lang=EN-US style='font-size:14.0pt;
line-height:107%;font-family:"Times New Roman","serif"'>tpNormal</span><span
style='font-size:14.0pt;line-height:107%;font-family:"Times New Roman","serif"'>,
а у второго </span><span lang=EN-US style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>tpLower</span><span style='font-size:
14.0pt;line-height:107%;font-family:"Times New Roman","serif"'> и оба потока
привязаны к одному и тому же ядру процессора, то первому потоку гораздо чаще
будет предоставляться процессорное время (например, 98%). С другой стороны,
если у этих же потоков не будет привязки к одному и тому же ядру, то они
получат одинаковое процессорное время. Скорее всего, оба варианта – это не то,
чего Вы хотите добиться при изменении относительного приоритета потока.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>Существует 2 крайних уровня приоритетов:
tpIdle и tpTimeCritical. Поток с приоритетом tpIdle получит процессорное время
только в том случае, если нет других активных потоков с более высоким
приоритетом. Поток с приоритетом tpTimeCritical будет забирать себе всё
процессорное время, т.е. потоки с более низким приоритетом не получат квант
времени, если выполняется поток с приоритетом tpTimeCritical. Это верно для
одноядерного процессора. Если процессор многоядерный (сейчас это обычная
ситуация), то, скорее всего, будут выполняться одновременно и поток с
приоритетом tpIdle и поток с приоритетом tpTimeCritical.</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#FAA4DD;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Заготовка для таблицы Внимание!</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='margin-left:5.4pt;background:#C2DAF0;border-collapse:collapse;
 border:none'>
 <tr>
  <td width=680 valign=top style='width:18.0cm;border:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
  justify;text-indent:35.45pt;line-height:normal'><span style='font-size:14.0pt;
  font-family:"Times New Roman","serif"'>Совет / рекомендация</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0cm;margin-bottom:.0001pt;text-align:
justify;text-indent:35.45pt'><span style='font-size:14.0pt;line-height:107%;
font-family:"Times New Roman","serif"'>&nbsp;</span></p>

<p class=MsoNormal style='text-indent:35.45pt'>&nbsp;</p>

</div>

</body>

</html>
